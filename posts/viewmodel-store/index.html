<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Android ‚Äî ViewModel factory and instantiation" /><meta property="og:locale" content="en" /><meta name="description" content="Android ViewModel is one of the most helpful APIs exist in the ecosystem. It‚Äôs a major release which changed how the Android apps built. Together with LiveData it decoupled the UI from business logic without much boilerplate. This post is about how the viewmodel is instatiated/cached/provided to the caller." /><meta property="og:description" content="Android ViewModel is one of the most helpful APIs exist in the ecosystem. It‚Äôs a major release which changed how the Android apps built. Together with LiveData it decoupled the UI from business logic without much boilerplate. This post is about how the viewmodel is instatiated/cached/provided to the caller." /><link rel="canonical" href="https://mahendranv.github.io/posts/viewmodel-store/" /><meta property="og:url" content="https://mahendranv.github.io/posts/viewmodel-store/" /><meta property="og:site_name" content="Mahendran" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-01T00:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Android ‚Äî ViewModel factory and instantiation" /><meta name="twitter:site" content="@mahevelai" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-10-01T23:58:58+05:30","datePublished":"2021-10-01T00:00:00+05:30","description":"Android ViewModel is one of the most helpful APIs exist in the ecosystem. It‚Äôs a major release which changed how the Android apps built. Together with LiveData it decoupled the UI from business logic without much boilerplate. This post is about how the viewmodel is instatiated/cached/provided to the caller.","headline":"Android ‚Äî ViewModel factory and instantiation","mainEntityOfPage":{"@type":"WebPage","@id":"https://mahendranv.github.io/posts/viewmodel-store/"},"url":"https://mahendranv.github.io/posts/viewmodel-store/"}</script><title>Android ‚Äî ViewModel factory and instantiation | Mahendran</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mahendran"><meta name="application-name" content="Mahendran"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/614333/01be055d-c668-46ba-8f7b-54065256c70d.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mahendran</a></div><div class="site-subtitle font-italic">Android | Kotlin | Springboot | DGS</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/series/" class="nav-link"> <i class="fa-fw fas fas fa-list-ol ml-xl-3 mr-xl-3 unloaded"></i> <span>SERIES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mahendranv" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/mahevelai" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://dev.to/mahendranv" aria-label="dev.to" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-dev"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG ‚Ä∫ <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Android ‚Äî ViewModel factory and instantiation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Android ‚Äî ViewModel factory and instantiation</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mahendran Vadivalagan </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 1, 2021, 12:00 AM +0530" >Oct 1, 2021<i class="unloaded">2021-10-01T00:00:00+05:30</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 1, 2021, 11:58 PM +0530" >Oct 1, 2021<i class="unloaded">2021-10-01T23:58:58+05:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="836 words">4 min read</span></div></div><div class="post-content"><p>Android ViewModel is one of the most helpful APIs exist in the ecosystem. It‚Äôs a major release which changed how the Android apps built. Together with LiveData it decoupled the UI from business logic without much boilerplate. This post is about how the viewmodel is instatiated/cached/provided to the caller.</p><hr /><h2 id="-api-doc">üìù API doc</h2><p>Before we get into specific usecases, let‚Äôs see few key players in this flow.</p><p>‚Ä¶</p><h3 id="factory">Factory</h3><p>Factory is an interface responsible for instantiating a viewmodel. It may or may not inject dependencies to the viewmodel.</p><p>‚Ä¶</p><h3 id="viewmodelstore--viewmodelstoreowner">ViewModelStore &amp; ViewModelStoreOwner</h3><p>ViewModelStore keeps a hashmap of String &amp; ViewModel. Once instantiated, viewmodel is stored in it. ViewModelStoreOwner is an interface implemented by Activity/Fragment. Under the hood a ViewModelStore is used by fragment/activity to store the reference.</p><p>‚Ä¶</p><h3 id="viewmodelprovider">ViewModelProvider</h3><p>ViewModelProvider is an umbrella object that coordinates Factory and ViewModelStore. Responsibility of this class is identifying the factory and caching viewmodel reference to ViewModelStore. There could be number of ViewModelProviders created in a fragment/activity. But when a viewmodel is requested, all of them will return the same instance. This is due to ViewModelStore‚Äôs single source of truth nature.</p><hr /><h2 id="Ô∏è-instantiation">üèóÔ∏è Instantiation</h2><p><strong>Note</strong>: Jetpack recommends <code class="language-plaintext highlighter-rouge">viewModels</code> / <code class="language-plaintext highlighter-rouge">activityViewModels</code> delegates to instantiate a ViewModel. However, for clarity this article will explain the usecases through <code class="language-plaintext highlighter-rouge">ViewModelProvider</code> instances.</p><h3 id="viewmodel-without-any-constructor-arguments">ViewModel without any constructor arguments</h3><p>This is a rare case where viewmodel doesn‚Äôt need any dependency. To instantiate such basic viewmodel, create a ViewModelProvider with current activity/fragment reference and invoke <code class="language-plaintext highlighter-rouge">get</code> method with ViewModel‚Äôs class.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kd">val</span> <span class="py">viewModel</span> <span class="p">=</span> <span class="nc">ViewModelProvider</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="c1">// Create reference wrt current fragment</span>
                 <span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="nc">ProfileViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span> <span class="c1">// query for a ProfileViewModel</span>
</pre></table></code></div></div><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/135651955-57519633-c183-4081-8ac0-4cd496712ed8.png" alt="image" /></p><p>‚Ä¶</p><h3 id="viewmodel-with-dependencies">ViewModel with dependencies</h3><p>Most common pattern with viewmodel is to pass constructor arguments (of data source) and do CRUD and emit events through LiveData. This can be done by creating a custom Factory and use it in place of default one. Internally, ViewModelProvider will use this factory to create the instance and store it to the viewmodelstore. Let‚Äôs see how it‚Äôs done.</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/135660480-6fa7298a-513b-4dac-80c5-1bc1e2d05461.png" alt="image" /></p><ol><li>Create a Factory which forwards constructor arguments to the ViewModel. This implements <code class="language-plaintext highlighter-rouge">ViewModelProvider.Factory</code>.<div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">ProfileViewModel</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">repo</span><span class="p">:</span> <span class="nc">DataRepository</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">()</span> <span class="p">{</span> 

     <span class="kd">class</span> <span class="nc">Factory</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">repo</span><span class="p">:</span> <span class="nc">DataRepository</span><span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModelProvider</span><span class="p">.</span><span class="nc">Factory</span> <span class="p">{</span>
         <span class="k">override</span> <span class="k">fun</span> <span class="p">&lt;</span><span class="nc">T</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">?&gt;</span> <span class="nf">create</span><span class="p">(</span><span class="n">modelClass</span><span class="p">:</span> <span class="nc">Class</span><span class="p">&lt;</span><span class="nc">T</span><span class="p">&gt;):</span> <span class="nc">T</span> <span class="p">{</span>
             <span class="k">return</span> <span class="nc">ProfileViewModel</span><span class="p">(</span><span class="n">repo</span><span class="p">)</span> <span class="k">as</span> <span class="nc">T</span>
         <span class="p">}</span>
     <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><li>Inside the fragment/activity, create a factory instance. And pass it to ViewModelProvider.</ol><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">val</span> <span class="py">dataRepo</span> <span class="p">=</span> <span class="nc">DataRepoImpl</span><span class="p">()</span> <span class="c1">// Data source</span>
<span class="kd">val</span> <span class="py">factory</span> <span class="p">=</span> <span class="nc">ProfileViewModel</span><span class="p">.</span><span class="nc">Factory</span><span class="p">(</span><span class="n">dataRepo</span><span class="p">)</span> <span class="c1">// Factory</span>
<span class="nc">ViewModelProvider</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="n">factory</span><span class="p">).</span><span class="k">get</span><span class="p">(</span><span class="nc">ProfileViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span> <span class="c1">// ViewModel</span>
</pre></table></code></div></div><p>‚Ä¶</p><p>Interesting thing about the ViewModelProvider is after instantiating the ViewModel in the scope (activity/fragment) next time invoking it will return the same viewmodel. That is</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nc">ViewModelProvider</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="k">get</span><span class="p">(</span><span class="nc">ProfileViewModel</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
</pre></table></code></div></div><p>will return the ViewModel created in second step. The order of calls matterns here.</p><hr /><h2 id="-few-questions">ü§î Few questions</h2><h3 id="how-viewmodel-survives-orientation-change">How ViewModel survives orientation change?</h3><p>This is not specific to ViewModel, but any retained object across activity recreation due to configuration change (orientation/locale). Android‚Äôs activity (yes!! The original activity) has <a href="https://developer.android.com/reference/android/app/Activity#onRetainNonConfigurationInstance()"><code class="language-plaintext highlighter-rouge">onRetainNonConfigurationInstance</code></a> method which can pass around objects between old and recreated activity instances. <a href="https://developer.android.com/reference/android/app/Activity#getLastNonConfigurationInstance()"><code class="language-plaintext highlighter-rouge">getLastNonConfigurationInstance</code></a> can capture the same in newly instantiated activity.</p><p>Catch is these methods are deprecated in favor of ViewModel which can achieve the same in a very graceful manner. To answer the question, <code class="language-plaintext highlighter-rouge">ViewModelStore</code> is passed between the activity instances.</p><hr /><h3 id="how-viewmodel-is-scoped-to-single-fragment">How ViewModel is scoped to single Fragment?</h3><p>When creating a Fragment with its scope, a nested ViewModelStore is created from its parent scope. This is applicable for Fragment inside an activity or even fragment. Few snippets to clarify things.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre><span class="c1">// FragmentManager.java</span>
<span class="k">if</span> <span class="o">(</span><span class="n">host</span> <span class="k">instanceof</span> <span class="nc">ViewModelStoreOwner</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">ViewModelStore</span> <span class="n">viewModelStore</span> <span class="o">=</span> <span class="o">((</span><span class="nc">ViewModelStoreOwner</span><span class="o">)</span> <span class="n">host</span><span class="o">).</span><span class="na">getViewModelStore</span><span class="o">();</span>
    <span class="n">mNonConfig</span> <span class="o">=</span> <span class="nc">FragmentManagerViewModel</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="n">viewModelStore</span><span class="o">);</span>
<span class="o">}</span>

<span class="c1">// FragmentManagerViewModel.java</span>
<span class="kd">final</span> <span class="kd">class</span> <span class="nc">FragmentManagerViewModel</span> <span class="kd">extends</span> <span class="nc">ViewModel</span> <span class="o">{</span>
  
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ViewModelStore</span><span class="o">&gt;</span> <span class="n">mViewModelStores</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HashMap</span><span class="o">&lt;&gt;();</span>

  <span class="nd">@NonNull</span>
    <span class="nc">ViewModelStore</span> <span class="nf">getViewModelStore</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Fragment</span> <span class="n">f</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">ViewModelStore</span> <span class="n">viewModelStore</span> <span class="o">=</span> <span class="n">mViewModelStores</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">mWho</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">viewModelStore</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">viewModelStore</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ViewModelStore</span><span class="o">();</span>
            <span class="n">mViewModelStores</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">f</span><span class="o">.</span><span class="na">mWho</span><span class="o">,</span> <span class="n">viewModelStore</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">viewModelStore</span><span class="o">;</span>
  <span class="o">}</span>


 <span class="c1">// Fragment.java</span>

 <span class="c1">// Internal unique name for this fragment;</span>
 <span class="nd">@NonNull</span>
 <span class="nc">String</span> <span class="n">mWho</span> <span class="o">=</span> <span class="no">UUID</span><span class="o">.</span><span class="na">randomUUID</span><span class="o">().</span><span class="na">toString</span><span class="o">();</span>
<span class="o">}</span>

</pre></table></code></div></div><p>This is how it works,</p><ul><li>Each fragment manager contains a FragmentManagerViewModel<li>FragmentManagerViewModel contains a map of string vs viewmodelstore<li>string in above step is UUID generated for each fragment and viewmodelstore is the one we‚Äôve seen in API doc section.</ul><hr /><h3 id="how-unique-is-the-key-in-viewmodelstore">How unique is the key in ViewModelStore?</h3><p>From ViewModelProvider who puts viewmodels into the ViewModelStore. Key is just the <code class="language-plaintext highlighter-rouge">CanonicalName</code> of the ViewModel. So, it‚Äôs purely based in class name. Since every fragment get its own store, it will not collide. Same makes it possible that fragments of the same activity to share viewmodels.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">DEFAULT_KEY</span> <span class="o">=</span>
            <span class="s">"androidx.lifecycle.ViewModelProvider.DefaultKey"</span><span class="o">;</span>
    
    <span class="nd">@NonNull</span>
    <span class="nd">@MainThread</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">ViewModel</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">get</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">modelClass</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">String</span> <span class="n">canonicalName</span> <span class="o">=</span> <span class="n">modelClass</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">canonicalName</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Local and anonymous classes can not be ViewModels"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">get</span><span class="o">(</span><span class="no">DEFAULT_KEY</span> <span class="o">+</span> <span class="s">":"</span> <span class="o">+</span> <span class="n">canonicalName</span><span class="o">,</span> <span class="n">modelClass</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><hr /><h2 id="-resources">üìí Resources</h2><ul><li><a href="https://developer.android.com/reference/android/app/Activity#getLastNonConfigurationInstance()">Activity</a><li><a href="https://developer.android.com/reference/androidx/lifecycle/ViewModelProvider?hl=en">ViewModelProvider</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>Android</a>, <a href='/categories/viewmodel/'>ViewModel</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >android</a> <a href="/tags/viewmodel/" class="post-tag no-text-decoration" >viewmodel</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Android ‚Äî ViewModel factory and instantiation - Mahendran&url=https://mahendranv.github.io/posts/viewmodel-store/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Android ‚Äî ViewModel factory and instantiation - Mahendran&u=https://mahendranv.github.io/posts/viewmodel-store/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Android ‚Äî ViewModel factory and instantiation - Mahendran&url=https://mahendranv.github.io/posts/viewmodel-store/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/hilt-instrument/">Android ‚Äî Instrumentation test with hilt</a><li><a href="/posts/hilt-codegen/">Smoke, mirrors & HiltViewModel</a><li><a href="/posts/hilt-viewmodel/">Android ‚Äî Basic Hilt setup with viewmodel + fragment</a><li><a href="/posts/viewmodel-store/">Android ‚Äî ViewModel factory and instantiation</a><li><a href="/posts/compose-shapes-gists/">I created few shapes in Jetpack compose / Gist included</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/kotlin-safe-cast/"><div class="card-body"> <span class="timeago small" >Apr 14, 2021<i class="unloaded">2021-04-14T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kotlin safe casting</h3><div class="text-muted small"><p> In multiple cases you might‚Äôve came across the situation where you have to cast a global variable and check the instance beforehand. A most common case in Android environment is to check whether...</p></div></div></a></div><div class="card"> <a href="/posts/kotlin-value-class/"><div class="card-body"> <span class="timeago small" >May 1, 2021<i class="unloaded">2021-05-01T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kotlin value class</h3><div class="text-muted small"><p> Kotlin‚Äôs data class is a fan favorite when it comes to storing any model. Bundled with bunch of necessary methods, devs get a lot while writing way less. From Kotlin 1.5 ‚Äî we have value class-s. L...</p></div></div></a></div><div class="card"> <a href="/posts/live-template/"><div class="card-body"> <span class="timeago small" >May 19, 2021<i class="unloaded">2021-05-19T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quickguide to intellij live template</h3><div class="text-muted small"><p> LiveTemplate is a feature in Intellij based IDEs where you can expand a code snippet by typing an abbreviation and the IDE guide your cursor through the parts that need your attention (a variable n...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/hilt-viewmodel/" class="btn btn-outline-primary" prompt="Older"><p>Android ‚Äî Basic Hilt setup with viewmodel + fragment</p></a> <a href="/posts/hilt-codegen/" class="btn btn-outline-primary" prompt="Newer"><p>Smoke, mirrors & HiltViewModel</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> ¬© 2022 <a href="https://twitter.com/mahevelai">Mahendran Vadivalagan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://mahendranv.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
