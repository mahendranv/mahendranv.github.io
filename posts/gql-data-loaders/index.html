<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="GraphQL backend — data loaders" /><meta property="og:locale" content="en" /><meta name="description" content="How to make use of graphql data loaders to write declarative data fetchers?" /><meta property="og:description" content="How to make use of graphql data loaders to write declarative data fetchers?" /><link rel="canonical" href="https://mahendranv.github.io/posts/gql-data-loaders/" /><meta property="og:url" content="https://mahendranv.github.io/posts/gql-data-loaders/" /><meta property="og:site_name" content="Mahendran" /><meta property="og:image" content="https://mahendranv.github.io/assets/img/data_loaders.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-05-21T00:00:00+05:30" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://mahendranv.github.io/assets/img/data_loaders.jpg" /><meta property="twitter:title" content="GraphQL backend — data loaders" /><meta name="twitter:site" content="@mahevelai" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-06-02T22:38:30+05:30","datePublished":"2021-05-21T00:00:00+05:30","description":"How to make use of graphql data loaders to write declarative data fetchers?","headline":"GraphQL backend — data loaders","image":"https://mahendranv.github.io/assets/img/data_loaders.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"https://mahendranv.github.io/posts/gql-data-loaders/"},"url":"https://mahendranv.github.io/posts/gql-data-loaders/"}</script><title>GraphQL backend — data loaders | Mahendran</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mahendran"><meta name="application-name" content="Mahendran"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/614333/01be055d-c668-46ba-8f7b-54065256c70d.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mahendran</a></div><div class="site-subtitle font-italic">Android | Kotlin | Springboot | DGS</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/series/" class="nav-link"> <i class="fa-fw fas fas fa-list-ol ml-xl-3 mr-xl-3 unloaded"></i> <span>SERIES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mahendranv" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/mahevelai" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://dev.to/mahendranv" aria-label="dev.to" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-dev"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>GraphQL backend — data loaders</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>GraphQL backend — data loaders</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mahendran Vadivalagan </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, May 21, 2021, 12:00 AM +0530" >May 21, 2021<i class="unloaded">2021-05-21T00:00:00+05:30</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Jun 2, 2021, 10:38 PM +0530" >Jun 2, 2021<i class="unloaded">2021-06-02T22:38:30+05:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1358 words">7 min read</span></div></div><div class="post-content"><p>In the <a href="https://mahendranv.github.io/posts/2021-05-20-gql-nested-objects/">previous post</a>, I created a FatExpense object and added manual checks to avoid fetching Account entity. If we’re scanning the selection manually and write our own check, what’s the role of GraphQL here?</p><p>Actually GraphQL handles all this, I just wanted show the problem of doing it manually. Let’s see what is what and what does each component do.</p><p>Here we’re looking at two problems</p><ol><li>We have to create Entity to match our schema model [FatExpense]<li>For each Expense — a query made to Account data source [i.e N+1 problem]</ol><p>Let me explain what is N+1 problem in breif and we can jump to the implementaion.</p><ul id="markdown-toc"><li><a href="#the-n1-problem" id="markdown-toc-the-n1-problem">The N+1 problem</a><li><a href="#-code-it" id="markdown-toc--code-it">👨‍💻 Code it</a><ul><li><a href="#preparing-your-datasource" id="markdown-toc-preparing-your-datasource">Preparing your datasource</a><li><a href="#create-a-batch-loader" id="markdown-toc-create-a-batch-loader">Create a batch loader</a><li><a href="#throw-away-the-fat-object" id="markdown-toc-throw-away-the-fat-object">Throw away the fat-object</a><li><a href="#tell-dgs-how-to-fetch-account" id="markdown-toc-tell-dgs-how-to-fetch-account">Tell DGS how to fetch Account</a></ul><li><a href="#-launch-it" id="markdown-toc--launch-it">🚀 Launch it</a><ul><li><a href="#how-does-it-scale" id="markdown-toc-how-does-it-scale">How does it scale?</a></ul><li><a href="#endnote" id="markdown-toc-endnote">Endnote</a><li><a href="#resources" id="markdown-toc-resources">Resources</a></ul><h2 id="the-n1-problem">The N+1 problem</h2><p>N+1 is when you make N queries from the outer object to get inner object. So the number of total queries made is 1 (outer object) + N (one query per row). In our example, we make 1 query to fetch Expense list and N queries to fill in account inside each expense. As nesting increase, it affects performance of the system.</p><p>Our <em>mock data set</em> is designed in a way that, all the expenses shared between three accounts. We consider our solution is a win when we achieve max 3 calls to the accounts source instead of 100 (one per expense).</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>
    <span class="kd">val</span> <span class="py">accounts</span> <span class="p">=</span> <span class="nf">mutableListOf</span><span class="p">(</span>
        <span class="nc">Account</span><span class="p">(</span><span class="n">acNumber</span> <span class="p">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nickName</span> <span class="p">=</span> <span class="s">"Wallet"</span><span class="p">,</span> <span class="n">balance</span> <span class="p">=</span> <span class="mi">100000</span><span class="p">),</span>
        <span class="nc">Account</span><span class="p">(</span><span class="n">acNumber</span> <span class="p">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">nickName</span> <span class="p">=</span> <span class="s">"Axis"</span><span class="p">,</span> <span class="n">balance</span> <span class="p">=</span> <span class="mi">240000</span><span class="p">),</span>
        <span class="nc">Account</span><span class="p">(</span><span class="n">acNumber</span> <span class="p">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">nickName</span> <span class="p">=</span> <span class="s">"ICICI"</span><span class="p">,</span> <span class="n">balance</span> <span class="p">=</span> <span class="mi">28000</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="kd">val</span> <span class="py">expenses</span> <span class="p">=</span> <span class="n">mutableListOf</span><span class="p">&lt;</span><span class="nc">Expense</span><span class="p">&gt;()</span>

    <span class="k">private</span> <span class="kd">val</span> <span class="py">random</span> <span class="p">=</span> <span class="nc">Random</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">randomExpense</span><span class="p">()</span> <span class="p">=</span> <span class="n">random</span><span class="p">.</span><span class="nf">nextInt</span><span class="p">(</span><span class="n">from</span> <span class="p">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">until</span> <span class="p">=</span> <span class="mi">800</span><span class="p">)</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="k">in</span> <span class="mi">1</span><span class="o">..</span><span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">expenses</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span>
                <span class="nc">Expense</span><span class="p">(</span>
                    <span class="n">id</span> <span class="p">=</span> <span class="n">i</span><span class="p">,</span>
                    <span class="n">amount</span> <span class="p">=</span> <span class="nf">randomExpense</span><span class="p">().</span><span class="n">absoluteValue</span><span class="p">,</span>
                    <span class="n">remarks</span> <span class="p">=</span> <span class="s">"Transaction $i"</span><span class="p">,</span>
                    <span class="n">isIncome</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span> <span class="p">%</span> <span class="mi">2</span> <span class="p">==</span> <span class="mi">0</span><span class="p">),</span>
                    <span class="n">acNumber</span> <span class="p">=</span> <span class="p">(</span><span class="n">i</span> <span class="p">%</span> <span class="mi">3</span> <span class="p">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

</pre></table></code></div></div><h2 id="-code-it">👨‍💻 Code it</h2><p>We need three components to decouple our entities and fix N+1 problem.</p><ol><li>DataSource that supports batch fetch<li>A DataLoader<li>DataFetcher that carries the context</ol><p><img data-proofer-ignore data-src="/assets/img/2021-05-21-23-13-33.png" alt="" /></p><h3 id="preparing-your-datasource">Preparing your datasource</h3><p>To alleviate the N fetches, what we can do is to find unique set of account numbers and then fetch them in one go. To achieve it, our data source has to support batch fetch of accounts as unlike our <code class="language-plaintext highlighter-rouge">get acccount by id</code> which deliver a single row of account. Let’s add it.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>
    <span class="k">fun</span> <span class="nf">getAccounts</span><span class="p">(</span><span class="n">acNumbers</span><span class="p">:</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;):</span> <span class="nc">List</span><span class="p">&lt;</span><span class="nc">Account</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="nf">println</span><span class="p">(</span><span class="s">"DAO.getAccounts - $acNumbers"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">accounts</span><span class="p">.</span><span class="nf">filter</span> <span class="p">{</span>
            <span class="n">acNumbers</span><span class="p">.</span><span class="nf">contains</span><span class="p">(</span><span class="n">it</span><span class="p">.</span><span class="n">acNumber</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

</pre></table></code></div></div><h3 id="create-a-batch-loader">Create a batch loader</h3><p>A batch loader is a component in GraphQL that extracts unique set of keys from series of requests and make a batch request to the data source. This way the resulting query is optimized to contain unique key/ids and only one fetch made to the data source.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>
<span class="nd">@DgsDataLoader</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"AccountNumberToAccount"</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">AccountsDataLoader</span> <span class="p">:</span> <span class="nc">BatchLoader</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">,</span> <span class="nc">Account</span><span class="p">&gt;</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">load</span><span class="p">(</span><span class="n">keys</span><span class="p">:</span> <span class="nc">MutableList</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">&gt;?)</span>
            <span class="p">:</span> <span class="nc">CompletionStage</span><span class="p">&lt;</span><span class="nc">MutableList</span><span class="p">&lt;</span><span class="nc">Account</span><span class="p">&gt;&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nc">CompletableFuture</span><span class="p">.</span><span class="nf">supplyAsync</span> <span class="p">{</span>
            <span class="k">return</span><span class="nd">@supplyAsync</span> <span class="nc">DataSource</span><span class="p">.</span><span class="nc">DAO</span>
                <span class="p">.</span><span class="nf">getAccounts</span><span class="p">(</span><span class="n">keys</span> <span class="o">?:</span> <span class="nf">emptyList</span><span class="p">())</span>
                <span class="p">.</span><span class="nf">toMutableList</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p>In the above code block, we register <code class="language-plaintext highlighter-rouge">AccountsDataLoader</code> to DGS registry under the alias of <code class="language-plaintext highlighter-rouge">AccountNumberToAccount</code>. This name acts like an identifier in <code class="language-plaintext highlighter-rouge">DgsDataFetchingEnvironment</code> to obtain the DataLoader.</p><p>It is a parameterized class, that maps Int (Account number) to Account entity and we have a <code class="language-plaintext highlighter-rouge">load</code> function that takes in set of unique account numbers and convert them to <code class="language-plaintext highlighter-rouge">Future</code>, that will be exucuted in batches. This <code class="language-plaintext highlighter-rouge">Future</code> nature of content fetch encourages GraphQLs async nature of resolving a query.</p><blockquote class="lead"><p><strong>Why it is a CompletableFuture instead of upfront fetch?</strong> <br />Assume each request from server to database takes 10ms. 100 sequntial calls to the database will endup in 1000 ms latency for a single field. Making the loader asynchronous enables us to fill in other fields for the response dynamically and deliver the result faster.</p></blockquote><h3 id="throw-away-the-fat-object">Throw away the fat-object</h3><p>If we create a wrapper entity for each nested query, we’ll endup creating a bunch of entities (or an obese one). DGS got it covered for us. Just delete the FatExpense and update the ExpenseDataFetcher with the original entity.</p><div class="language-diff highlighter-rouge"><div class="code-header"> <span text-data=" Diff "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>
+++ b/src/main/kotlin/com/ex2/gql/expense/fetchers/ExpenseDataFetcher.kt
 
     @DgsData(parentType = "Query", field = "expenses")
<span class="gd">-    fun expenses(dfe: DgsDataFetchingEnvironment): List&lt;FatExpense&gt; {
-        return DataSource.expenses.map {
-            val result = FatExpense(
-                id = it.id,
-                amount = it.amount,
-                remarks = it.remarks,
-                isIncome = it.isIncome,
-                account = null
-            )
-
-            val loadAccount = dfe.field
-                .selectionSet
-                .selections
-                .any { field -&gt; (field as? graphql.language.Field)?.name == "account" }
-
-            if (loadAccount) {
-                result.account = DataSource.DAO.getAccount(it.acNumber)
-            }
-            result
-        }
</span><span class="gi">+    fun expenses(dfe: DgsDataFetchingEnvironment): List&lt;Expense&gt; {
+        return DataSource.expenses
</span>     }

</pre></table></code></div></div><h3 id="tell-dgs-how-to-fetch-account">Tell DGS how to fetch Account</h3><p>Now that we deleted the <code class="language-plaintext highlighter-rouge">FatExpense</code> class, we have to wire up the connection between Expense and Account. We do it in Account Data fetcher. First revisit the schema before do the linking.</p><div class="language-graphql highlighter-rouge"><div class="code-header"> <span text-data=" GraphQL "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="k">type</span><span class="w"> </span><span class="n">Expense</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="err">...</span><span class="w">
    </span><span class="n">account</span><span class="p">:</span><span class="w"> </span><span class="n">Account</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></pre></table></code></div></div><p>We have a type called Expense and it holds a field <code class="language-plaintext highlighter-rouge">account</code> of type Account. Inside DGSData annotation, mention the parentType and which field in the schema it resolves. And pass down the dfe (DgsDataFetchingEnvironment) context for fetching Account.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>
    <span class="nd">@DgsData</span><span class="p">(</span><span class="n">parentType</span> <span class="p">=</span> <span class="s">"Expense"</span><span class="p">,</span> <span class="n">field</span> <span class="p">=</span> <span class="s">"account"</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">getAccount</span><span class="p">(</span><span class="n">dfe</span><span class="p">:</span> <span class="nc">DgsDataFetchingEnvironment</span><span class="p">):</span> <span class="nc">CompletableFuture</span><span class="p">&lt;</span><span class="nc">Account</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">dataLoader</span><span class="p">:</span> <span class="nc">DataLoader</span><span class="p">&lt;</span><span class="nc">Int</span><span class="p">,</span> <span class="nc">Account</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">dfe</span><span class="p">.</span><span class="nf">getDataLoader</span><span class="p">(</span><span class="nc">AccountsDataLoader</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">source</span> <span class="p">=</span> <span class="n">dfe</span><span class="p">.</span><span class="n">getSource</span><span class="p">&lt;</span><span class="nc">Expense</span><span class="p">&gt;()</span>
        <span class="kd">val</span> <span class="py">acNumber</span> <span class="p">=</span> <span class="n">source</span><span class="p">.</span><span class="n">acNumber</span>
        <span class="k">return</span> <span class="n">dataLoader</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">acNumber</span><span class="p">)</span>
    <span class="p">}</span>

</pre></table></code></div></div><blockquote><p><code class="language-plaintext highlighter-rouge">dfe</code> passes context information such as source from which this request originated and selection (fields required in account entity) to the called function.</p></blockquote><p>Inside the function body, from <code class="language-plaintext highlighter-rouge">DgsDataFetchingEnvironment</code> we get a loader for AccountsDataLoader. It is important to use dfe to create the loader, as it sets scope for the data loader. This helps to reuse the same loader for each Expense that tries to load account information. <code class="language-plaintext highlighter-rouge">dfe</code> carries the callers scope that we can get using <code class="language-plaintext highlighter-rouge">getSource</code>. From there, we can retrieve the account number and queue account fetch request. Just leaving a note here, the parentType</p><p>That’s it, we don’t have to make any check on <code class="language-plaintext highlighter-rouge">selection</code> or create an entity that matches the schema or manually club the N+1 queries. A data loader and a <code class="language-plaintext highlighter-rouge">DgsData</code> annotation will handle scoping — de-duplicating &amp; delivering result in async manner.</p><h2 id="-launch-it">🚀 Launch it</h2><p>Launch <code class="language-plaintext highlighter-rouge">http://localhost:8080/graphiql</code> in browser and feed the below query. And check the <code class="language-plaintext highlighter-rouge">DataSource.DAO#getAccounts</code> logs.</p><div class="language-graphql highlighter-rouge"><div class="code-header"> <span text-data=" GraphQL "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="w">
</span><span class="k">query</span><span class="w"> </span><span class="n">Expense</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="n">expenses</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">id</span><span class="w">
    </span><span class="n">remarks</span><span class="w">
    </span><span class="n">amount</span><span class="w">
    </span><span class="n">account</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="n">acNumber</span><span class="w">
      </span><span class="n">nickName</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c">### Logs</span><span class="w">

</span><span class="err">DAO.getAccounts</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">[2</span><span class="p">,</span><span class="w"> </span><span class="err">3</span><span class="p">,</span><span class="w"> </span><span class="err">1]</span><span class="w">

</span></pre></table></code></div></div><p>We have a single fetch request made to the account data source with a batch of account numbers.</p><h3 id="how-does-it-scale">How does it scale?</h3><p>Let’s say we have another data type called <code class="language-plaintext highlighter-rouge">Transfer</code> with <code class="language-plaintext highlighter-rouge">from</code> and <code class="language-plaintext highlighter-rouge">to</code> — both fields of type Account. All we need to do is to declare two functions for <code class="language-plaintext highlighter-rouge">from</code> and <code class="language-plaintext highlighter-rouge">to</code> fields. Rest of the DataLoader and DataSource changes can be reused.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    <span class="nd">@DgsData</span><span class="p">(</span><span class="n">parentType</span> <span class="p">=</span> <span class="s">"Transfer"</span><span class="p">,</span> <span class="n">field</span> <span class="p">=</span> <span class="s">"from"</span><span class="p">)</span>
    <span class="o">..</span><span class="p">.</span>
    <span class="nd">@DgsData</span><span class="p">(</span><span class="n">parentType</span> <span class="p">=</span> <span class="s">"Transfer"</span><span class="p">,</span> <span class="n">field</span> <span class="p">=</span> <span class="s">"to"</span><span class="p">)</span>
    <span class="o">..</span><span class="p">.</span>

</pre></table></code></div></div><h2 id="endnote">Endnote</h2><p>With three components added to the codebase (two of them reusable), we have a decoupled yet context aware data loading in our system. Here we explored <code class="language-plaintext highlighter-rouge">BatchLoader</code> — one of the commonly used loader. There are other types such as <code class="language-plaintext highlighter-rouge">BatchLoaderWithContext</code>, <code class="language-plaintext highlighter-rouge">MappedBatchLoader</code> and <code class="language-plaintext highlighter-rouge">MappedBatchLoaderWithContext</code> each tailored to address specific usecase. Make use of them and enjoy GraphQL<em>ing</em> your backend.</p><p>DataLoader is part of <a href="https://github.com/graphql-java">java-graphql</a> project and not specific to DGS. Role of DGS here is to provide a solid registry for data fetchers &amp; loaders.</p><h2 id="resources">Resources</h2><ul><li><a href="https://github.com/mahendranv/spring-expenses/commit/ffa51a9cf081772c72002dfca61541f252cbe925">Commit: Migrating to DataLoader</a><li><a href="https://github.com/mahendranv/spring-expenses">Spring-expenses Repository</a><li><a href="https://github.com/graphql-java/java-dataloader">java-dataloader</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/graphql/'>GraphQL</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/graphql/" class="post-tag no-text-decoration" >graphql</a> <a href="/tags/springboot/" class="post-tag no-text-decoration" >springboot</a> <a href="/tags/kotlin/" class="post-tag no-text-decoration" >kotlin</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=GraphQL backend — data loaders - Mahendran&url=https://mahendranv.github.io/posts/gql-data-loaders/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=GraphQL backend — data loaders - Mahendran&u=https://mahendranv.github.io/posts/gql-data-loaders/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=GraphQL backend — data loaders - Mahendran&url=https://mahendranv.github.io/posts/gql-data-loaders/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/hilt-instrument/">Android — Instrumentation test with hilt</a><li><a href="/posts/hilt-codegen/">Smoke, mirrors & HiltViewModel</a><li><a href="/posts/hilt-viewmodel/">Android — Basic Hilt setup with viewmodel + fragment</a><li><a href="/posts/viewmodel-store/">Android — ViewModel factory and instantiation</a><li><a href="/posts/compose-shapes-gists/">I created few shapes in Jetpack compose / Gist included</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/gql-simple-backend/"><div class="card-body"> <span class="timeago small" >May 17, 2021<i class="unloaded">2021-05-17T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GraphQL - simple backend server - SpringBoot application</h3><div class="text-muted small"><p> In this post, I’ll cover how to create a simple GraphQL server with Springboot and Netflix DGS. DGS is chosen because you start with GraphQL schema and then build server side logic around it. P...</p></div></div></a></div><div class="card"> <a href="/posts/gql-delete-update/"><div class="card-body"> <span class="timeago small" >May 18, 2021<i class="unloaded">2021-05-18T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GraphQL backend — update & delete</h3><div class="text-muted small"><p> In the first installment, I covered create and read operations to the Expense entity. Now let’s add few more operations ⇨ update and delete queries. Entire source code is available in github. For ...</p></div></div></a></div><div class="card"> <a href="/posts/gql-nested-objects/"><div class="card-body"> <span class="timeago small" >May 20, 2021<i class="unloaded">2021-05-20T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>GraphQL backend — nested objects</h3><div class="text-muted small"><p> A nested object is like a Matryoshka doll where one object placed inside another and you can choose to not open the next level — a perfect usecase to demonstrate the power of GraphQL. In this post...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/gql-nested-objects/" class="btn btn-outline-primary" prompt="Older"><p>GraphQL backend — nested objects</p></a> <a href="/posts/gql-filters-pagination/" class="btn btn-outline-primary" prompt="Newer"><p>GraphQL backend — pagination & filters</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/mahevelai">Mahendran Vadivalagan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://mahendranv.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
