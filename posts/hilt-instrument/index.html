<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Android — Instrumentation test with hilt" /><meta property="og:locale" content="en" /><meta name="description" content="Testing in Android has been a pain from the beginning and there is no standard architecture setup to execute the frictionless test. As you know there is no silver bullet for all the snags. This piece of article covers how do you fake dependencies to your hilt-viewmodel and assert the same from fragment using espresso." /><meta property="og:description" content="Testing in Android has been a pain from the beginning and there is no standard architecture setup to execute the frictionless test. As you know there is no silver bullet for all the snags. This piece of article covers how do you fake dependencies to your hilt-viewmodel and assert the same from fragment using espresso." /><link rel="canonical" href="https://mahendranv.github.io/posts/hilt-instrument/" /><meta property="og:url" content="https://mahendranv.github.io/posts/hilt-instrument/" /><meta property="og:site_name" content="Mahendran" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-20T00:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Android — Instrumentation test with hilt" /><meta name="twitter:site" content="@mahevelai" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-10-21T22:28:44+05:30","datePublished":"2021-10-20T00:00:00+05:30","description":"Testing in Android has been a pain from the beginning and there is no standard architecture setup to execute the frictionless test. As you know there is no silver bullet for all the snags. This piece of article covers how do you fake dependencies to your hilt-viewmodel and assert the same from fragment using espresso.","headline":"Android — Instrumentation test with hilt","mainEntityOfPage":{"@type":"WebPage","@id":"https://mahendranv.github.io/posts/hilt-instrument/"},"url":"https://mahendranv.github.io/posts/hilt-instrument/"}</script><title>Android — Instrumentation test with hilt | Mahendran</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mahendran"><meta name="application-name" content="Mahendran"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/614333/01be055d-c668-46ba-8f7b-54065256c70d.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mahendran</a></div><div class="site-subtitle font-italic">Android | Kotlin | Springboot | DGS</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/series/" class="nav-link"> <i class="fa-fw fas fas fa-list-ol ml-xl-3 mr-xl-3 unloaded"></i> <span>SERIES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mahendranv" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/mahevelai" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://dev.to/mahendranv" aria-label="dev.to" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-dev"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Android — Instrumentation test with hilt</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Android — Instrumentation test with hilt</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mahendran Vadivalagan </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Oct 20, 2021, 12:00 AM +0530" >Oct 20, 2021<i class="unloaded">2021-10-20T00:00:00+05:30</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Oct 21, 2021, 10:28 PM +0530" >Oct 21, 2021<i class="unloaded">2021-10-21T22:28:44+05:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1554 words">8 min read</span></div></div><div class="post-content"><p>Testing in Android has been a pain from the beginning and there is no standard architecture setup to execute the frictionless test. As you know there is no silver bullet for all the snags. This piece of article covers how do you fake dependencies to your hilt-viewmodel and assert the same from fragment using espresso.</p><p>What do we achieve here?</p><ol><li>Decoupled UI from navigation and real data source<li>Feed fake data to our viewmodel<li>A less flaky test since we control the data</ol><p>-or- Explained in a single picture</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/138287967-00a8e391-54b1-4f7d-a239-239ac98c12b1.png" alt="image" style="zoom: 30%;" /></p><blockquote><p>Thanks: <a href="https://www.youtube.com/watch?v=QTli1HU9axY&amp;ab_channel=MrBean">Mr. Bean - Art disaster</a></p></blockquote><p>…</p><h2 id="testing-strategy">Testing strategy</h2><p>100% code coverage is a myth and the more you squeeze towards it, you end up with flaky tests. Provided the content is dynamic and involves latency due to API calls, it is simply hard to achieve. So, to what degree we should write tests?</p><p><img data-proofer-ignore data-src="https://miro.medium.com/max/1400/1*6M7_pT_2HJR-o-AXgkHU0g.jpeg" alt="image" style="zoom:50%;" /></p><blockquote><p>credits: <a href="https://medium.com/android-testing-daily/the-3-tiers-of-the-android-test-pyramid-c1211b359acd">medium</a></p></blockquote><ul><li><strong>Unit tests:</strong> Small &amp; fast. Even with a large number of tests, there won’t be much impact on execution time.<li><strong>Integration tests</strong>: Covers how a system integrates with others. ex. How viewmodel works with the data source. Cover the touchpoints. Runs on JVM – reliable.<li><strong>UI tests</strong>: Tests that cover UI interactions. In android, this means launching an emulator and running tests in it. Slow! dead slow!! So, write tests to assert fixed UI states. <a href="#wrapup">Wrapup</a> at the end of the article should give a rough idea of execution time.</ul><p>Here we cover how to write the integration and UI tests using hilt. Before the actual implementation, take a minute to read on <a href="https://martinfowler.com/bliki/TestDouble.html">test double</a>s (literally a very short article!). We’ll be using Fakes in our tests. Keep in mind while coding:</p><ol><li><strong>Hilt resolves a dependency by its type.</strong> So, our code should refer to the <em>Fake</em>able dependency as interface.<li><strong>Provide your dependency in module</strong>. So that the whole module can be faked along with dependencies. More on this is covered in <a href="#faking-modules">faking modules</a> section</ol><p>…</p><h2 id="dependency-overview">Dependency overview</h2><p>To recap from <a href="https://dev.to/mahendranv/android-basic-hilt-setup-with-viewmodel-fragment-32fd">previous article</a>, we have a fragment that requires a Profile (POJO) object which is provided through a ViewModel. <code class="language-plaintext highlighter-rouge">DataRepository</code> acts as a source of truth here and returns a profile. <code class="language-plaintext highlighter-rouge">ProfileViewModel</code> is unaware of the implementation of <code class="language-plaintext highlighter-rouge">DataRepository</code> and Hilt resolves it at compile time.</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/138072585-ec3fc907-88d7-40cd-bf2b-2d6cb0a28a98.png" alt="dependency overview" style="zoom:67%;" /></p><p>Adding to the existing implementation, we’ll bring in our Fake data source <code class="language-plaintext highlighter-rouge">FakeDataRepoImpl</code> for tests. So, the rest of the post is about instructing Hilt to use <code class="language-plaintext highlighter-rouge">FakeDataRepoImpl</code> instead of <code class="language-plaintext highlighter-rouge">DataRepositoryImpl</code>.</p><hr /><h2 id="test-runner-setup">Test runner setup</h2><p>Add test dependencies to app level gradle file. This brings a <code class="language-plaintext highlighter-rouge">HiltTestApplication</code> and annotation processor to the project now. As we’ve seen in the <a href="https://dev.to/mahendranv/android-basic-hilt-setup-with-viewmodel-fragment-32fd#little-about-scope">scope section</a>, <code class="language-plaintext highlighter-rouge">HiltTestApplication</code> will hold singleton component.</p><div class="language-groovy highlighter-rouge"><div class="code-header"> <span text-data=" Groovy "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// File: app/build.gradle</span>

<span class="n">dependencies</span> <span class="o">{</span>
    <span class="c1">// Hilt - testing</span>
    <span class="n">androidTestImplementation</span> <span class="s1">'com.google.dagger:hilt-android-testing:2.38.1'</span>
    <span class="n">kaptAndroidTest</span> <span class="s1">'com.google.dagger:hilt-android-compiler:2.38.1'</span>
<span class="o">}</span>
</pre></table></code></div></div><p>Although <code class="language-plaintext highlighter-rouge">HiltTestApplication</code> is present in our app, it is not used in tests yet. This hookup is done by defining a <code class="language-plaintext highlighter-rouge">CustomTestRunner</code>. It points to the test application when instantiating the application class for instrument tests.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="c1">// File: app/src/androidTest/java/com/ex2/hiltespresso/CustomTestRunner.kt</span>

<span class="k">import</span> <span class="nn">androidx.test.runner.AndroidJUnitRunner</span>
<span class="k">import</span> <span class="nn">dagger.hilt.android.testing.HiltTestApplication</span>

<span class="kd">class</span> <span class="nc">CustomTestRunner</span> <span class="p">:</span> <span class="nc">AndroidJUnitRunner</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">newApplication</span><span class="p">(</span>
        <span class="n">cl</span><span class="p">:</span> <span class="nc">ClassLoader</span><span class="p">?,</span>
        <span class="n">className</span><span class="p">:</span> <span class="nc">String</span><span class="p">?,</span>
        <span class="n">context</span><span class="p">:</span> <span class="nc">Context</span><span class="p">?</span>
    <span class="p">):</span> <span class="nc">Application</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">super</span><span class="p">.</span><span class="nf">newApplication</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="nc">HiltTestApplication</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>And the final step is to declare the test runner in app/gradle file.</p><div class="language-groovy highlighter-rouge"><div class="code-header"> <span text-data=" Groovy "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1">// File: app/build.gradle</span>

<span class="n">android</span> <span class="o">{</span>

    <span class="n">defaultConfig</span> <span class="o">{</span>
    <span class="c1">//  testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"</span>
        <span class="n">testInstrumentationRunner</span> <span class="s2">"com.ex2.hiltespresso.CustomTestRunner"</span>
    <span class="o">}</span>

</pre></table></code></div></div><hr /><h2 id="shared-test-fakes">Shared test fakes</h2><p>In android, there are Unit and Instrumentation tests. Although both identify as tests, they cannot share resources between them. Here, few places where tests will lookup for classes.</p><ol><li><p><code class="language-plaintext highlighter-rouge">main</code> source set - here we place the production code. Fakes have no place here</p><li><p><code class="language-plaintext highlighter-rouge">testShared</code> source set - This is the recommended way to share resources. Create the below directory structure and place the <code class="language-plaintext highlighter-rouge">FakeDataRepoImpl</code> there.</p></ol><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/138258099-2215cf0f-ed2a-4269-9981-0f9e2b03c4a8.png" alt="shared-test" /></p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="c1">// File: app/src/testShared/java/com/ex2/hiltespresso/data/FakeDataRepoImpl.kt</span>

<span class="kd">class</span> <span class="nc">FakeDataRepoImpl</span> <span class="nd">@Inject</span> <span class="k">constructor</span><span class="p">()</span> <span class="p">:</span> <span class="nc">DataRepository</span> <span class="p">{</span>

    <span class="k">override</span> <span class="k">fun</span> <span class="nf">getProfile</span><span class="p">()</span> <span class="p">=</span> <span class="nc">Profile</span><span class="p">(</span><span class="n">name</span> <span class="p">=</span> <span class="s">"Fake Name"</span><span class="p">,</span> <span class="n">age</span> <span class="p">=</span> <span class="mi">47</span><span class="p">)</span>
<span class="p">}</span>

</pre></table></code></div></div><p>The next step is to add this to <code class="language-plaintext highlighter-rouge">test</code> and <code class="language-plaintext highlighter-rouge">androidTest</code> source sets. In app level gradle file, include <code class="language-plaintext highlighter-rouge">testShared</code> source set to test sources.</p><div class="language-groovy highlighter-rouge"><div class="code-header"> <span text-data=" Groovy "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="c1">// File: app/build.gradle</span>

<span class="n">android</span> <span class="o">{</span>
        <span class="n">sourceSets</span> <span class="o">{</span>
        <span class="n">test</span> <span class="o">{</span>
            <span class="n">java</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">+=</span> <span class="s2">"$projectDir/src/testShared"</span>
        <span class="o">}</span>
        <span class="n">androidTest</span> <span class="o">{</span>
            <span class="n">java</span><span class="o">.</span><span class="na">srcDirs</span> <span class="o">+=</span> <span class="s2">"$projectDir/src/testShared"</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><hr /><h2 id="writing-integration-test">Writing integration test</h2><p>In the integration test, we’ll verify data source and viewmodel coupling is proper. As seen in the testing strategy section, tests run faster if the emulator is not involved. Here, <em>ViewModel</em> can be tested without UI. All it needs is the <code class="language-plaintext highlighter-rouge">DataRepository</code>. In the last section, we placed the <code class="language-plaintext highlighter-rouge">FakeDataRepoImpl</code> in the shared source set. Let’s manually inject it and assert the data.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// File: app/src/test/java/com/ex2/hiltespresso/ui/profile/ProfileViewModelTest.kt</span>

<span class="nd">@RunWith</span><span class="p">(</span><span class="nc">JUnit4</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
<span class="kd">class</span> <span class="nc">ProfileViewModelTest</span> <span class="p">{</span>

    <span class="k">lateinit</span> <span class="kd">var</span> <span class="py">SUT</span><span class="p">:</span> <span class="nc">ProfileViewModel</span>

    <span class="nd">@Before</span>
    <span class="k">fun</span> <span class="nf">init</span><span class="p">()</span> <span class="p">{</span>
        <span class="nc">SUT</span> <span class="p">=</span> <span class="nc">ProfileViewModel</span><span class="p">(</span><span class="nc">FakeDataRepoImpl</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`Profile</span> <span class="n">fetched</span> <span class="n">from</span> <span class="nf">repository`</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">assertThat</span><span class="p">(</span><span class="s">"Name consumed from data source"</span><span class="p">,</span> <span class="nc">SUT</span><span class="p">.</span><span class="nf">getProfile</span><span class="p">().</span><span class="n">name</span><span class="p">,</span> <span class="nf">`is`</span><span class="p">(</span><span class="s">"Fake Name"</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><strong>💡 Why ProfileViewModel is instantiated manually instead of using Hilt?</strong></p><p>This is the piece of HiltViewModelFactory which instantiates <code class="language-plaintext highlighter-rouge">ProfileViewModel</code>. The <code class="language-plaintext highlighter-rouge">SavedStateRegistryOwner</code>, <code class="language-plaintext highlighter-rouge">defaultArgs</code> are coming from Activity/Fragment that is marked with <code class="language-plaintext highlighter-rouge">@AndroidEntryPoint</code>. So, instantiating the viewmodel with hilt also brings in the complexity of launching the activity and testing the viewmodel from there. This will result in a slower test whereas viewmodel test can run on JVM like we did above.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="nc">HiltViewModelFactory</span><span class="p">(</span>
      <span class="nd">@NonNull</span> <span class="nc">SavedStateRegistryOwner</span> <span class="n">owner</span><span class="p">,</span>
      <span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">defaultArgs</span><span class="p">,</span>
      <span class="nd">@NonNull</span> <span class="nc">Set</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">&gt;</span> <span class="n">hiltViewModelKeys</span><span class="p">,</span>
      <span class="nd">@NonNull</span> <span class="nc">ViewModelProvider</span><span class="p">.</span><span class="nc">Factory</span> <span class="n">delegateFactory</span><span class="p">,</span>
      <span class="nd">@NonNull</span> <span class="nc">ViewModelComponentBuilder</span> <span class="n">viewModelComponentBuilder</span><span class="p">)</span>
</pre></table></code></div></div><hr /><h2 id="instrumentation-or-ui-tests">Instrumentation or UI tests</h2><p>Instrumentation/UI tests run on emulator. For this project we’ll assert whether the name in UI matches the one in (fake) data source.</p><p>In a real-world application, the data source is dynamic and mostly involves a web service. This means UI tests tend to get flaky. So, the ideal approach is to bring down the UI to have <a href="https://en.wikipedia.org/wiki/Finite-state_machine">finite-states</a> and map it to the ViewModel and fake it.</p><blockquote><p><strong><u>Example UI states</u></strong> :</p><ol><li>UI when the network response has failed<li>UI when there are N items in the list vs the empty state.</ol></blockquote><p>Kotlin <a href="https://kotlinlang.org/docs/sealed-classes.html">sealed classes</a> are a good fit to design an FSM. The aforementioned use-cases are not covered here!! (and won’t fall into a straight line to write an article). So, here is the blueprint on how do we inject our fake for ViewModel.</p><p>…</p><h3 id="faking-modules">Faking modules</h3><p>For instrument tests (androidTest), hilt is responsible for instantiating the ViewModel. So, we need someone who speaks Hilt’s language. Create a fake module that will provide our <code class="language-plaintext highlighter-rouge">FakeDataRepoImpl</code> to the viewmodel.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// File: app/src/androidTest/java/com/ex2/hiltespresso/di/FakeProfileModule.kt</span>

<span class="k">import</span> <span class="nn">dagger.hilt.android.components.ViewModelComponent</span>
<span class="k">import</span> <span class="nn">dagger.hilt.testing.TestInstallIn</span>

<span class="c1">// Hey Hilt!! Forget about the ProfileModule - use me instead</span>
<span class="nd">@TestInstallIn</span><span class="p">(</span>
    <span class="n">components</span> <span class="p">=</span> <span class="p">[</span><span class="nc">ViewModelComponent</span><span class="o">::</span><span class="k">class</span><span class="p">],</span>
    <span class="n">replaces</span> <span class="p">=</span> <span class="p">[</span><span class="nc">ProfileModule</span><span class="o">::</span><span class="k">class</span><span class="p">]</span>
<span class="p">)</span>
<span class="nd">@Module</span>
<span class="kd">class</span> <span class="nc">FakeProfileModule</span> <span class="p">{</span>

    <span class="nd">@Provides</span>
    <span class="k">fun</span> <span class="nf">getProfileSource</span><span class="p">():</span> <span class="nc">DataRepository</span> <span class="p">=</span> <span class="nc">FakeDataRepoImpl</span><span class="p">()</span>

<span class="p">}</span>
</pre></table></code></div></div><p>Notice the <code class="language-plaintext highlighter-rouge">TestInstallIn</code> annotation. Defining the replaces array will make the original <code class="language-plaintext highlighter-rouge">ProfileModule</code> replaced with <code class="language-plaintext highlighter-rouge">FakeProfileModule</code>. While building the component, hilt will replace the original module (and thus dependencies) and instantiate the ViewModel with the fake repo. Our UI will use the viewmodel and tests will assert the same.</p><p>…</p><h3 id="the-hiltandroidtest">The HiltAndroidTest</h3><p>The final piece is to write a test that uses the faked component. All it needs is a couple of test rules and annotation from Hilt. Rest is generated!!</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c1">// File: app/src/androidTest/java/com/ex2/hiltespresso/MainActivityHiltTest.kt</span>

<span class="nd">@RunWith</span><span class="p">(</span><span class="nc">AndroidJUnit4</span><span class="o">::</span><span class="k">class</span><span class="p">)</span>
<span class="nd">@HiltAndroidTest</span>
<span class="kd">class</span> <span class="nc">MainActivityHiltTest</span> <span class="p">{</span>

    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Rule</span><span class="p">(</span><span class="n">order</span> <span class="p">=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="kd">var</span> <span class="py">hiltRule</span> <span class="p">=</span> <span class="nc">HiltAndroidRule</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>

    <span class="err">@</span><span class="k">get</span><span class="p">:</span><span class="nc">Rule</span><span class="p">(</span><span class="n">order</span> <span class="p">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="kd">var</span> <span class="py">activityRule</span><span class="p">:</span> <span class="nc">ActivityScenarioRule</span><span class="p">&lt;</span><span class="nc">MainActivity</span><span class="p">&gt;</span> <span class="p">=</span>
        <span class="nc">ActivityScenarioRule</span><span class="p">(</span><span class="nc">MainActivity</span><span class="o">::</span><span class="k">class</span><span class="p">.</span><span class="n">java</span><span class="p">)</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">test_name_matches_data_source</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// Inject the dependencies to the test (if there is any @Inject field in the test)</span>
        <span class="n">hiltRule</span><span class="p">.</span><span class="nf">inject</span><span class="p">()</span>
        <span class="nc">Espresso</span><span class="p">.</span><span class="nf">onView</span><span class="p">(</span><span class="nc">ViewMatchers</span><span class="p">.</span><span class="nf">withId</span><span class="p">(</span><span class="nc">R</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">name_label</span><span class="p">))</span>
            <span class="p">.</span><span class="nf">check</span><span class="p">(</span>
                <span class="nc">ViewAssertions</span><span class="p">.</span><span class="nf">matches</span><span class="p">(</span>
                    <span class="nc">Matchers</span><span class="p">.</span><span class="nf">allOf</span><span class="p">(</span>
                        <span class="nc">ViewMatchers</span><span class="p">.</span><span class="nf">isDisplayed</span><span class="p">(),</span>
                        <span class="nc">ViewMatchers</span><span class="p">.</span><span class="nf">withText</span><span class="p">(</span><span class="s">"Fake Name"</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The rules are executed first before running the test. It ensures the activity has dependencies resolved before test execution.</p><ol><li><code class="language-plaintext highlighter-rouge">HiltAndroidRule</code> (order = 0) : First create components (singleton, activity, fragment, viewmodel) and obey the <code class="language-plaintext highlighter-rouge">replace</code> contract mentioned in previous step.<li><code class="language-plaintext highlighter-rouge">ActivityScenarioRule</code> (order = 1): Launch the activity mentioned before each test</ol><p>The espresso &amp; hamcrest matchers are descriptive. In the view tree, it lookup for a view and assert whether it’s visible and carries the text defined in fake data repo.</p><hr /><h2 id="wrapup">Wrapup</h2><p>This article gave a blueprint for organizing the code in order to achieve component links in isolation. Apart from the hilt-related setup, this practice could benefit even the code that was built with manual injection. Just follow these key takeaways.</p><ol><li>Always define the data source as interface. So that it can be faked/mocked for tests.<li>Make <code class="language-plaintext highlighter-rouge">fragment / activity</code>’s UI controlled by the viewmodel. You don’t have to fake the link here.<li>A viewmodel should emit finite states to the UI at any point of time. This state may be dictated by the data source or a reaction to user input in UI (eg. enabling a button based on content length)</ol><p>…</p><p>In case you wonder about the execution time, here it is: 5ms vs 3.5 sec</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/138306415-970c2d37-30df-4ce0-99a1-713740253031.png" alt="junit" /></p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/138306231-b0305b0d-9c06-47cc-aa81-59c34cdba1e8.png" alt="espresso" /></p><p>…</p><h2 id="resources">Resources</h2><ul><li><a href="https://github.com/mahendranv/hilt-espresso">Github project</a><li><a href="https://developer.android.com/training/dependency-injection/hilt-testing">Hilt testing</a><li><a href="https://en.wikipedia.org/wiki/Finite-state_machine">Finite-state machine</a><li><a href="https://medium.com/android-testing-daily/the-3-tiers-of-the-android-test-pyramid-c1211b359acd">Android test pyramid</a><li><a href="https://martinfowler.com/bliki/TestDouble.html">Test doubles</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>Android</a>, <a href='/categories/hilt/'>Hilt</a>, <a href='/categories/espresso/'>Espresso</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >android</a> <a href="/tags/hilt/" class="post-tag no-text-decoration" >hilt</a> <a href="/tags/espresso/" class="post-tag no-text-decoration" >espresso</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Android — Instrumentation test with hilt - Mahendran&url=https://mahendranv.github.io/posts/hilt-instrument/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Android — Instrumentation test with hilt - Mahendran&u=https://mahendranv.github.io/posts/hilt-instrument/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Android — Instrumentation test with hilt - Mahendran&url=https://mahendranv.github.io/posts/hilt-instrument/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/hilt-instrument/">Android — Instrumentation test with hilt</a><li><a href="/posts/hilt-codegen/">Smoke, mirrors & HiltViewModel</a><li><a href="/posts/hilt-viewmodel/">Android — Basic Hilt setup with viewmodel + fragment</a><li><a href="/posts/viewmodel-store/">Android — ViewModel factory and instantiation</a><li><a href="/posts/compose-shapes-gists/">I created few shapes in Jetpack compose / Gist included</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/hilt-viewmodel/"><div class="card-body"> <span class="timeago small" >Sep 28, 2021<i class="unloaded">2021-09-28T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android — Basic Hilt setup with viewmodel + fragment</h3><div class="text-muted small"><p> Hilt is a modern android DI framework for dependency injection. It is merely a wrapper around Dagger2. Forget dagger-android, hilt brings a lot to our plate. This article covers steps to add hilt t...</p></div></div></a></div><div class="card"> <a href="/posts/hilt-codegen/"><div class="card-body"> <span class="timeago small" >Oct 4, 2021<i class="unloaded">2021-10-04T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Smoke, mirrors & HiltViewModel</h3><div class="text-muted small"><p> This is the second installment in the three-part series. To understand better, you can read part1 or open the github project to explore the code. Part1: Android — Basic Hilt setup with viewmodel +...</p></div></div></a></div><div class="card"> <a href="/posts/kotlin-safe-cast/"><div class="card-body"> <span class="timeago small" >Apr 14, 2021<i class="unloaded">2021-04-14T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kotlin safe casting</h3><div class="text-muted small"><p> In multiple cases you might’ve came across the situation where you have to cast a global variable and check the instance beforehand. A most common case in Android environment is to check whether...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/hilt-codegen/" class="btn btn-outline-primary" prompt="Older"><p>Smoke, mirrors & HiltViewModel</p></a> <a href="/posts/android-gradle-deps-kit/" class="btn btn-outline-primary" prompt="Newer"><p>Android Utility belt — Collection of dependencies for a greenfield project</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/mahevelai">Mahendran Vadivalagan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://mahendranv.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
