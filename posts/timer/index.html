<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Android ‚Äî Implementing LifecycleAwareTimer" /><meta property="og:locale" content="en" /><meta name="description" content="Android CountDownTimer is good but it can be better. This article covers few tweaks to the timer and in general how to decouple certain logic from activity." /><meta property="og:description" content="Android CountDownTimer is good but it can be better. This article covers few tweaks to the timer and in general how to decouple certain logic from activity." /><link rel="canonical" href="https://mahendranv.github.io/posts/timer/" /><meta property="og:url" content="https://mahendranv.github.io/posts/timer/" /><meta property="og:site_name" content="Mahendran" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-06-18T00:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Android ‚Äî Implementing LifecycleAwareTimer" /><meta name="twitter:site" content="@mahevelai" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-06-19T22:29:48+05:30","datePublished":"2021-06-18T00:00:00+05:30","description":"Android CountDownTimer is good but it can be better. This article covers few tweaks to the timer and in general how to decouple certain logic from activity.","headline":"Android ‚Äî Implementing LifecycleAwareTimer","mainEntityOfPage":{"@type":"WebPage","@id":"https://mahendranv.github.io/posts/timer/"},"url":"https://mahendranv.github.io/posts/timer/"}</script><title>Android ‚Äî Implementing LifecycleAwareTimer | Mahendran</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mahendran"><meta name="application-name" content="Mahendran"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/614333/01be055d-c668-46ba-8f7b-54065256c70d.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mahendran</a></div><div class="site-subtitle font-italic">Android | Kotlin | Springboot | DGS</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/series/" class="nav-link"> <i class="fa-fw fas fas fa-list-ol ml-xl-3 mr-xl-3 unloaded"></i> <span>SERIES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mahendranv" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/mahevelai" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://dev.to/mahendranv" aria-label="dev.to" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-dev"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG ‚Ä∫ <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Android ‚Äî Implementing LifecycleAwareTimer</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Android ‚Äî Implementing LifecycleAwareTimer</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mahendran Vadivalagan </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Jun 18, 2021, 12:00 AM +0530" >Jun 18, 2021<i class="unloaded">2021-06-18T00:00:00+05:30</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Jun 19, 2021, 10:29 PM +0530" >Jun 19, 2021<i class="unloaded">2021-06-19T22:29:48+05:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1404 words">7 min read</span></div></div><div class="post-content"><p>Android CountDownTimer is good but it can be better. This article covers few tweaks to the timer and in general how to decouple certain logic from activity.</p><h2 id="-background">üìö Background</h2><p>CountDownTimer is a convenient API in android when it comes to implementing a timer. However, it lacks few features that have to be filled in by the host Activity /Fragment. Let‚Äôs draft a user story.</p><blockquote><p>‚ùì As a user, I should see a countdown timer that expires at an absolute time.</p></blockquote><p>There are multiple ways to achieve this in Android. You can use any of the below APIs.</p><ol><li>Coroutines-with-delay<li>Thread-handler-sleep<li>CountdownTimer</ol><p>I‚Äôm picking the <code class="language-plaintext highlighter-rouge">CountdownTimer</code>, when we reach the end of the article, it‚Äôll be clear why we‚Äôre not using the first two.</p><p>‚Ä¶</p><h2 id="-reading-between-lines">üëì Reading between lines</h2><p>The user story says it should expire at an absolute time. Let‚Äôs assume an offer will expire at 10:00 am. It will expire at 10 whether the activity is running or not. i.e timeout is not bound to the activity or fragment launch time. The timer is merely an attempt to highlight user that he has xx time left till expiry.</p><p>No need to explain what a timer is ‚Äî for our use-case, it ticks per second.</p><p>‚Ä¶</p><h2 id="-countdowntimer">‚è≤ CountDownTimer</h2><p>CountDownTimer is a simple API that makes use of android‚Äôs <code class="language-plaintext highlighter-rouge">Handler.sendMessageDelayed</code> to emit elapsed value in a given interval. This is an abstract class where we have to provide the implementation for the following methods:</p><ol><li><code class="language-plaintext highlighter-rouge">onTick</code> ‚Äî once every xx-interval<li><code class="language-plaintext highlighter-rouge">onFinish</code> ‚Äî time out</ol><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>   <span class="k">object</span><span class="p">:</span> <span class="nc">CountDownTimer</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
       <span class="k">override</span> <span class="k">fun</span> <span class="nf">onTick</span><span class="p">(</span><span class="n">millisUntilFinished</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span> <span class="p">{}</span>
       <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFinish</span><span class="p">()</span> <span class="p">{}</span>
   <span class="p">}</span>
</pre></table></code></div></div><p>‚Ä¶</p><h2 id="Ô∏è-implementation">‚öôÔ∏è Implementation</h2><p>Implementing it in our activity/fragment is plain and simple. Compute eta and interval, create a timer, start it and update UI on each tick and then finish it when it‚Äôs complete.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre>
<span class="kd">class</span> <span class="nc">OfferActivity</span><span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">expiresAt</span> <span class="p">=</span> <span class="c1">// 10 am in millis</span>
    <span class="kd">var</span> <span class="py">timer</span><span class="p">:</span> <span class="nc">CountDownTimer</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">startTimer</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">startTimer</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// If timer already running cancel it</span>
        <span class="n">timer</span><span class="o">?.</span><span class="nf">cancel</span><span class="p">()</span>

        <span class="kd">val</span> <span class="py">eta</span> <span class="p">=</span> <span class="n">expiresAt</span> <span class="p">-</span> <span class="nc">System</span><span class="p">.</span><span class="nf">currentTimeMillis</span><span class="p">()</span>
        <span class="kd">val</span> <span class="py">interval</span> <span class="p">=</span> <span class="mi">1000</span> <span class="c1">// every 1 sec</span>
        <span class="n">timer</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">CountDownTimer</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onTick</span><span class="p">(</span><span class="n">millisUntilFinished</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// oversimplified version</span>
                <span class="n">timerLabel</span> <span class="p">=</span> <span class="s">"${millisUntilFinished/1000} seconds left"</span>
            <span class="p">}</span>

            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFinish</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">timerLabel</span> <span class="p">=</span> <span class="s">"offer expired"</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">timer</span><span class="o">?.</span><span class="nf">start</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">onDestroy</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">?.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p>This is an okayish implementation, but it‚Äôs flawed. Even when the app is in the background, the countdown still runs. So, naturally, like any android developer, we resort to lifecycle methods.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>
<span class="k">fun</span> <span class="nf">onPause</span><span class="p">()</span> <span class="p">{</span> 
    <span class="n">timer</span><span class="o">?.</span><span class="nf">cancel</span><span class="p">()</span> 
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">onResume</span><span class="p">()</span> <span class="p">{</span> 
    <span class="nf">startTimer</span><span class="p">()</span> 
<span class="p">}</span>

</pre></table></code></div></div><p>This will work fine for one activity, but when we need the timer in multiple places, it just clutters the activity with a bunch of lifecycle methods, and missing one of them will end up in a timer that runs in the background or something that doesn‚Äôt resume when activity is foreground. Fortunately, we have a way to remove this clutter with a delegate.</p><p>‚Ä¶</p><h2 id="-decluttering-activity">üßπ Decluttering activity</h2><p>LifecycleObserver is an interface from androidx which can register to the activity lifecycle and act on behalf of it. This way, the activity will live clean, yet the concerned class can react to the activity lifecycle. In further sections, we‚Äôll create a wrapper for the countdown timer and register for lifecycle events.</p><h3 id="registering-to-lifecycle">Registering to lifecycle</h3><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">LifecycleAwareTimer</span><span class="p">(</span><span class="n">stopAt</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nc">Long</span><span class="p">))</span> <span class="p">{</span>

    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_RESUME</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">onResume</span><span class="p">()</span> <span class="p">{}</span>

    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_PAUSE</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">onPause</span><span class="p">()</span> <span class="p">{}</span>

    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_DESTROY</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">onDestroy</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">OfferActivity</span><span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">private</span> <span class="k">fun</span> <span class="nf">startTimer</span><span class="p">()</span> <span class="p">{</span>
        <span class="c1">// ... </span>
        <span class="n">lifecycle</span><span class="p">.</span><span class="nf">addObserver</span><span class="p">(</span><span class="nc">LifecycleAwareTimer</span><span class="p">(</span><span class="n">stopAt</span><span class="p">,</span> <span class="n">interval</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Now we have a skeleton of LifecycleAwareTimer which is connected to our activity and subscribed to lifecycle events. Next thing is to move our CountDownTimer to the wrapper.</p><p>‚Ä¶</p><h3 id="moving-countdown-timer">Moving countdown timer</h3><p>Create a CountDownTimer inside the wrapper and start/cancel it as per the lifecycle callback. Also, consider the case when the timer expires and don‚Äôt start it.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">LifecycleAwareTimer</span><span class="p">(</span><span class="n">stopAt</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">private</span> <span class="kd">var</span> <span class="py">timer</span><span class="p">:</span> <span class="nc">CountDownTimer</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">expired</span><span class="p">:</span> <span class="nc">Boolean</span>
        <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="p">(</span><span class="n">stopAt</span> <span class="p">-</span> <span class="nc">System</span><span class="p">.</span><span class="nf">currentTimeMillis</span><span class="p">())</span> <span class="p">&lt;=</span> <span class="mi">0</span>

    <span class="k">fun</span> <span class="nf">startTimer</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">?.</span><span class="nf">cancel</span><span class="p">()</span>
        <span class="n">timer</span> <span class="p">=</span> <span class="k">null</span>

        <span class="kd">val</span> <span class="py">eta</span> <span class="p">=</span> <span class="n">stopAt</span> <span class="p">-</span> <span class="nc">System</span><span class="p">.</span><span class="nf">currentTimeMillis</span><span class="p">()</span>
        <span class="n">timer</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">CountDownTimer</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onTick</span><span class="p">(</span><span class="n">millisUntilFinished</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span> <span class="p">{}</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFinish</span><span class="p">()</span> <span class="p">{}</span>
        <span class="p">}</span>
        <span class="n">timer</span><span class="o">?.</span><span class="nf">start</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">discardTimer</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">?.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_RESUME</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">onResume</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">expired</span><span class="p">)</span> <span class="p">{</span>
            <span class="nf">discardTimer</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nf">startTimer</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_PAUSE</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">onPause</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span><span class="o">?.</span><span class="nf">cancel</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_DESTROY</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">onDestroy</span><span class="p">()</span> <span class="p">{</span>
        <span class="nf">discardTimer</span><span class="p">()</span>
    <span class="p">}</span>
</pre></table></code></div></div><p>So far, the timer connects to the activity and internally starts/cancels the countdown. But it doesn‚Äôt deliver results to the host. Let‚Äôs wire it up.</p><p>‚Ä¶</p><h3 id="callbacks-to-the-host">Callbacks to the host</h3><p>Create a callback interface to update events from the underlying timer to the host activity and implement the same in Activity.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">interface</span> <span class="nc">TimerCallback</span><span class="p">:</span> <span class="nc">LifecycleOwner</span> <span class="p">{</span>

    <span class="k">fun</span> <span class="nf">onTick</span><span class="p">(</span><span class="n">millisUntilFinished</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span>

    <span class="k">fun</span> <span class="nf">onTimeOut</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">class</span> <span class="nc">OfferActivity</span> <span class="p">:</span> <span class="nc">AppCompatActivity</span><span class="p">(),</span> <span class="nc">TimerCallback</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">onTick</span><span class="p">(</span><span class="n">millisUntilFinished</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/** seconds ticking **/</span> <span class="p">}</span>
    <span class="k">fun</span> <span class="nf">onTimeOut</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/** expired**/</span> <span class="p">}</span>
<span class="p">}</span>

</pre></table></code></div></div><p>LifecycleAwareTimer takes in the callback and delivers the result to it. Add the callback to the constructor argument and forward values to the activity.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">LifecycleAwareTimer</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">stopAt</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">interval</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">callback</span><span class="p">:</span> <span class="nc">TimerCallback</span>
<span class="p">)</span> <span class="p">{</span>
    
    <span class="k">fun</span> <span class="nf">startTimer</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">timer</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">CountDownTimer</span><span class="p">(</span><span class="n">eta</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onTick</span><span class="p">(</span><span class="n">millisUntilFinished</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">callback</span><span class="p">.</span><span class="nf">onTick</span><span class="p">(</span><span class="n">millisUntilFinished</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFinish</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">callback</span><span class="p">.</span><span class="nf">onTimeOut</span><span class="p">()</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">timer</span><span class="o">?.</span><span class="nf">start</span><span class="p">()</span>

</pre></table></code></div></div><p>‚Ä¶</p><h3 id="offhooking-the-observer">Offhooking the observer</h3><p>Since our <code class="language-plaintext highlighter-rouge">TimerCallback</code> is also LifecycleOwner, registering/unregistering for lifecycle can be done right within the LifecycleAwareTimer. It registers for a callback when created and removes itself when activity is destroyed or the timer is expired.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">LifecycleAwareTimer</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">stopAt</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">interval</span><span class="p">:</span> <span class="nc">Long</span><span class="p">,</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">callback</span><span class="p">:</span> <span class="nc">TimerCallback</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="nf">init</span> <span class="p">{</span>
        <span class="n">callback</span><span class="p">.</span><span class="n">lifecycle</span><span class="p">.</span><span class="nf">addObserver</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">discardTimer</span><span class="p">()</span> <span class="p">{</span>
            <span class="n">timer</span><span class="o">?.</span><span class="nf">cancel</span><span class="p">()</span>
            <span class="n">callback</span><span class="p">.</span><span class="n">lifecycle</span><span class="p">.</span><span class="nf">removeObserver</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>    
    <span class="p">}</span>

    <span class="o">..</span><span class="p">.</span>
    <span class="n">timer</span> <span class="p">=</span> <span class="kd">object</span> <span class="err">: </span><span class="nc">CountDownTimer</span> <span class="p">{</span>
        <span class="k">override</span> <span class="k">fun</span> <span class="nf">onFinish</span><span class="p">()</span> <span class="p">{</span>
                <span class="n">callback</span><span class="p">.</span><span class="nf">onTimeOut</span><span class="p">()</span>
                <span class="nf">discardTimer</span><span class="p">()</span>
            <span class="p">}</span>
    <span class="p">}</span>

    <span class="o">..</span><span class="p">.</span>

    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_DESTROY</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">onDestroy</span><span class="p">()</span> <span class="p">{</span> <span class="nf">discardTimer</span><span class="p">()</span> <span class="p">}</span>

    <span class="nd">@OnLifecycleEvent</span><span class="p">(</span><span class="nc">Lifecycle</span><span class="p">.</span><span class="nc">Event</span><span class="p">.</span><span class="nc">ON_RESUME</span><span class="p">)</span>
    <span class="k">fun</span> <span class="nf">onResume</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">expired</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">callback</span><span class="p">.</span><span class="nf">onTimeOut</span><span class="p">()</span>
            <span class="nf">discardTimer</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Try to resume timer</span>
            <span class="nf">startTimer</span><span class="p">()</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></table></code></div></div><h3 id="activity-side-implementation">Activity side implementation</h3><p>Now pretty much the timer implementation is complete, let‚Äôs have a look at the activity. It holds a timer reference (to avoid duplicate timers) initializes and starts it. Receives callback from onTick &amp; onTimeOut.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="c1">// Activity</span>

    <span class="k">private</span> <span class="kd">var</span> <span class="py">timer</span><span class="p">:</span> <span class="nc">LifecycleAwareTimer</span><span class="p">?</span> <span class="p">=</span> <span class="k">null</span>

    <span class="k">fun</span> <span class="nf">startTimer</span><span class="p">(){</span> 
       <span class="n">timer</span><span class="o">?.</span><span class="nf">discardTimer</span><span class="p">()</span>
       <span class="n">timer</span> <span class="p">=</span> <span class="nc">LifecycleAwareTimer</span><span class="p">(</span><span class="n">stopAt</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="k">this</span><span class="p">)</span>
       <span class="n">timer</span><span class="o">?.</span><span class="nf">startTimer</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">fun</span> <span class="nf">onTick</span><span class="p">(</span><span class="n">millisUntilFinished</span><span class="p">:</span> <span class="nc">Long</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/** seconds ticking **/</span> <span class="p">}</span>
    <span class="k">fun</span> <span class="nf">onTimeOut</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/** expired**/</span> <span class="p">}</span>
</pre></table></code></div></div><h2 id="-endnote">üìî Endnote</h2><p>This might look like an exaggerated version of the timer. But we have a lot of benefits with this approach:</p><ul><li>Timer depends on <code class="language-plaintext highlighter-rouge">LifecycleOwner</code> which means, it can be used with both fragment and activity<li>Timer reacts to lifecycle without explicitly writing much at the host activity/fragment<li>When activity destroyed, the timer kills itself and unregister from lifecycle callbacks<li>Timer pauses when activity hits background and resumes or deliver timeout result when the host hits the surface back</ul><p><strong>Why didn‚Äôt we use coroutine?</strong> The same behavior can be emulated using a coroutine that dispatches to the Main thread. But a disadvantage is we‚Äôll end up owning the elapsed time computation. We still have to use the lifecycle callbacks to manage the coroutine job. And the coroutine itself will contain a while loop with delay and dispatch. When it comes to CountDownTimer, it dispatches messages at a given interval which is organic to the android system.</p><p>Comple code is available as <a href="https://gist.github.com/mahendranv/16c4354be67215f0e24c78da9882eef1">gist</a>.</p><p>üßë‚Äçüíª Happy coding üßë‚Äçüíª</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>Android</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >android</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Android ‚Äî Implementing LifecycleAwareTimer - Mahendran&url=https://mahendranv.github.io/posts/timer/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Android ‚Äî Implementing LifecycleAwareTimer - Mahendran&u=https://mahendranv.github.io/posts/timer/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Android ‚Äî Implementing LifecycleAwareTimer - Mahendran&url=https://mahendranv.github.io/posts/timer/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/hilt-instrument/">Android ‚Äî Instrumentation test with hilt</a><li><a href="/posts/hilt-codegen/">Smoke, mirrors & HiltViewModel</a><li><a href="/posts/hilt-viewmodel/">Android ‚Äî Basic Hilt setup with viewmodel + fragment</a><li><a href="/posts/viewmodel-store/">Android ‚Äî ViewModel factory and instantiation</a><li><a href="/posts/compose-shapes-gists/">I created few shapes in Jetpack compose / Gist included</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/kotlin-safe-cast/"><div class="card-body"> <span class="timeago small" >Apr 14, 2021<i class="unloaded">2021-04-14T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kotlin safe casting</h3><div class="text-muted small"><p> In multiple cases you might‚Äôve came across the situation where you have to cast a global variable and check the instance beforehand. A most common case in Android environment is to check whether...</p></div></div></a></div><div class="card"> <a href="/posts/kotlin-value-class/"><div class="card-body"> <span class="timeago small" >May 1, 2021<i class="unloaded">2021-05-01T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kotlin value class</h3><div class="text-muted small"><p> Kotlin‚Äôs data class is a fan favorite when it comes to storing any model. Bundled with bunch of necessary methods, devs get a lot while writing way less. From Kotlin 1.5 ‚Äî we have value class-s. L...</p></div></div></a></div><div class="card"> <a href="/posts/live-template/"><div class="card-body"> <span class="timeago small" >May 19, 2021<i class="unloaded">2021-05-19T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quickguide to intellij live template</h3><div class="text-muted small"><p> LiveTemplate is a feature in Intellij based IDEs where you can expand a code snippet by typing an abbreviation and the IDE guide your cursor through the parts that need your attention (a variable n...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/kotlin-flow1/" class="btn btn-outline-primary" prompt="Older"><p>Flow is non-blocking but the collector is not</p></a> <a href="/posts/compose-shapes/" class="btn btn-outline-primary" prompt="Newer"><p>Jetpack compose - shape your views</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> ¬© 2022 <a href="https://twitter.com/mahevelai">Mahendran Vadivalagan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://mahendranv.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
