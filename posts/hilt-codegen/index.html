<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Smoke, mirrors &amp; HiltViewModel" /><meta property="og:locale" content="en" /><meta name="description" content="This is the second installment in the three-part series. To understand better, you can read part1 or open the github project to explore the code." /><meta property="og:description" content="This is the second installment in the three-part series. To understand better, you can read part1 or open the github project to explore the code." /><link rel="canonical" href="https://mahendranv.github.io/posts/hilt-codegen/" /><meta property="og:url" content="https://mahendranv.github.io/posts/hilt-codegen/" /><meta property="og:site_name" content="Mahendran" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-04T00:00:00+05:30" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Smoke, mirrors &amp; HiltViewModel" /><meta name="twitter:site" content="@mahevelai" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-10-06T21:43:03+05:30","datePublished":"2021-10-04T00:00:00+05:30","description":"This is the second installment in the three-part series. To understand better, you can read part1 or open the github project to explore the code.","headline":"Smoke, mirrors &amp; HiltViewModel","mainEntityOfPage":{"@type":"WebPage","@id":"https://mahendranv.github.io/posts/hilt-codegen/"},"url":"https://mahendranv.github.io/posts/hilt-codegen/"}</script><title>Smoke, mirrors & HiltViewModel | Mahendran</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mahendran"><meta name="application-name" content="Mahendran"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://dev-to-uploads.s3.amazonaws.com/uploads/user/profile_image/614333/01be055d-c668-46ba-8f7b-54065256c70d.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mahendran</a></div><div class="site-subtitle font-italic">Android | Kotlin | Springboot | DGS</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/series/" class="nav-link"> <i class="fa-fw fas fas fa-list-ol ml-xl-3 mr-xl-3 unloaded"></i> <span>SERIES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/mahendranv" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/mahevelai" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="https://dev.to/mahendranv" aria-label="dev.to" class="order-5" target="_blank" rel="noopener"> <i class="fab fa-dev"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Smoke, mirrors & HiltViewModel</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Smoke, mirrors & HiltViewModel</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mahendran Vadivalagan </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Oct 4, 2021, 12:00 AM +0530" >Oct 4, 2021<i class="unloaded">2021-10-04T00:00:00+05:30</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Oct 6, 2021, 9:43 PM +0530" >Oct 6, 2021<i class="unloaded">2021-10-06T21:43:03+05:30</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2105 words">11 min read</span></div></div><div class="post-content"><p>This is the second installment in the three-part series. To understand better, you can read part1 or open the <a href="https://github.com/mahendranv/hilt-espresso">github project</a> to explore the code.</p><p><a href="https://mahendranv.github.io/posts/hilt-viewmodel/"><strong>Part1:</strong> Android — Basic Hilt setup with viewmodel + fragment</a></p><p><strong>Part2: Smoke, mirrors &amp; HiltViewModel</strong></p><p><strong>Part3:</strong> Fakes and espresso</p><p>…</p><h2 id="introduction">Introduction</h2><p>In a typical Android project creating a ViewModel with dependencies require us to provide an explicit viewmodel-factory. However, in the previous post Hilt was able to create one without all the boilerplate. This post covers the smoke and mirrors behind viewmodel instantiation with hilt.</p><p>As I write and revise the article, noticed it has a lot of moving parts. So, I tried to segregate it into four portions.</p><ol><li>Dagger: Hilt is based on dagger, so this portion covers few dagger concepts<li>HiltViewModel: Hilt marks viewmodels with this annotation. What happens when you do this marking.<li>AndroidEntryPoint: A Fragment/Activity is called as AndroidEntryPoint in Hilt. This again bootstraps few things for us.<li>HiltViewModelFactory: It’s better to read this at the very end.</ol><p>…</p><h2 id="️--stabbing-with-dagger">🗡️ Stabbing with Dagger</h2><p>In order to understand the mechanics of Hilt, let’s recall few Dagger components.</p><h3 id="providers--factories">Providers &amp; Factories</h3><p>Our focus is on how the ViewModel is instantiated. So, this portion covers enough dagger to demonstrate a constructor injection. Let’s see an example of how Car gets its Engine. Engine has no dependencies and car will need one Engine to work. The same can be written in code like this.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="nn">javax.inject.Inject</span>

<span class="c1">// Hey Dagger! Create a factory for me, so that you can create my instances.</span>
<span class="kd">class</span> <span class="nc">Engine</span> <span class="nd">@Inject</span> <span class="k">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">start</span><span class="p">()</span> <span class="p">{</span> <span class="nf">println</span><span class="p">(</span><span class="s">"Engine.start"</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">fun</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">{</span> <span class="nf">println</span><span class="p">(</span><span class="s">"Engine.stop"</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Hey Dagger! Create a factory for me, so that you can create my instances.</span>
<span class="c1">// Also provide me with my dependencies.</span>
<span class="kd">class</span> <span class="nc">Car</span> <span class="nd">@Inject</span> <span class="k">constructor</span><span class="p">(</span><span class="k">private</span> <span class="kd">val</span> <span class="py">engine</span><span class="p">:</span> <span class="nc">Engine</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">start</span><span class="p">()</span> <span class="p">=</span> <span class="n">engine</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span>
    <span class="k">fun</span> <span class="nf">stop</span><span class="p">()</span> <span class="p">=</span> <span class="n">engine</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span>
<span class="p">}</span>
</pre></table></code></div></div><p>…</p><p>For this piece to work, dagger generates <code class="language-plaintext highlighter-rouge">Factory</code>s. There are three things to remember here.</p><ol><li>Factory is an interface defined in Dagger with only one getter to the target object.<li>A Factory can include <code class="language-plaintext highlighter-rouge">Provider</code>s which can provide the dependencies for it. For example, Car factory will need a Provider for Engine.<li>Factory is extended from <code class="language-plaintext highlighter-rouge">Provider</code>. Which means Engine factory can act as a provider for car factory.</ol><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="c1">// source: Dagger</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Provider</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="cm">/**
     * Provides a fully-constructed and injected instance of {@code T}.
     */</span>
    <span class="no">T</span> <span class="nf">get</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Factory</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nc">Provider</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{}</span>
</pre></table></code></div></div><p>…</p><p>This is the overview of dagger-factory for Car &amp; Engine usecase.</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/135588702-8afdcbcc-8d49-436f-a175-ebb1e90e94b1.png" alt="image" /></p><p>…</p><p>Engine_Factory is simple. It extends dagger Factory and returns new instance when <code class="language-plaintext highlighter-rouge">get()</code> is called.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">dagger.internal.DaggerGenerated</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">dagger.internal.Factory</span><span class="o">;</span>

<span class="nd">@DaggerGenerated</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Engine_Factory</span> <span class="kd">implements</span> <span class="nc">Factory</span><span class="o">&lt;</span><span class="nc">Engine</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Engine</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newInstance</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Engine</span> <span class="nf">newInstance</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Engine</span><span class="o">();</span>
  <span class="o">}</span>
  <span class="c1">// redacted</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Car_Factory</code> needs an engine to create car. For this purpose, it needs a <code class="language-plaintext highlighter-rouge">Provider</code> which can get an engine for it. The car provider is defined as a constructor parameter and Dagger uses components &amp; scopes to resolve it.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="nd">@DaggerGenerated</span>
<span class="nd">@SuppressWarnings</span><span class="o">({</span>
    <span class="s">"unchecked"</span><span class="o">,</span>
    <span class="s">"rawtypes"</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Car_Factory</span> <span class="kd">implements</span> <span class="nc">Factory</span><span class="o">&lt;</span><span class="nc">Car</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Provider</span><span class="o">&lt;</span><span class="nc">Engine</span><span class="o">&gt;</span> <span class="n">engineProvider</span><span class="o">;</span>

  <span class="c1">// Engine provider will be set through dagger module/components</span>
  <span class="kd">public</span> <span class="nf">Car_Factory</span><span class="o">(</span><span class="nc">Provider</span><span class="o">&lt;</span><span class="nc">Engine</span><span class="o">&gt;</span> <span class="n">engineProvider</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">engineProvider</span> <span class="o">=</span> <span class="n">engineProvider</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">Car</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newInstance</span><span class="o">(</span><span class="n">engineProvider</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">Car</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">Engine</span> <span class="n">engine</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Car</span><span class="o">(</span><span class="n">engine</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>…</p><h3 id="dagger-binds">Dagger binds</h3><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Circle</span> <span class="kd">extends</span> <span class="nc">Shape</span> <span class="o">{</span>
  <span class="c1">// redacted</span>
<span class="o">}</span>

<span class="nd">@Module</span>
<span class="kd">interface</span> <span class="nc">ShapeModule</span> <span class="o">{</span>

  <span class="nd">@Binds</span>
  <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">Shape</span> <span class="nf">binds</span><span class="o">(</span><span class="nc">Circle</span> <span class="n">c</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">Binds</code> is a contract that tells dagger to return the argument in place of the return type. The above statement is to be read as “when <code class="language-plaintext highlighter-rouge">Shape</code> is requested, return <code class="language-plaintext highlighter-rouge">Circle</code>”. This could work well for one-to-one mapping where the abstraction is only there to loosely couple the implementation.</p><h3 id="dagger-map-multibindings">Dagger map-multibindings</h3><p>It is a common practice in programming where we keep a lookup registry and query an object by a unique key. <a href="https://dagger.dev/dev-guide/multibindings.html">Dagger map</a> is the same, with a decoupled approach.</p><ol><li>Map instance is scoped to component<li>Map elements are managed at compile time. That means multiple modules can contribute to the map without knowing about each other. In fact, they don’t get the map instance to look up in the first place.<li>Map is an injectable dependency for the consumer. This consumer should have the knowledge about which key to lookup.</ol><p>In the above example, whenever we need a <code class="language-plaintext highlighter-rouge">Shape</code>, <code class="language-plaintext highlighter-rouge">Circle</code> will be returned. What if I want a square? Dagger multibinding can help with that.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="nd">@Binds</span>
<span class="nd">@IntoMap</span>
<span class="nd">@StringKey</span><span class="o">(</span><span class="s">"circle"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">Shape</span> <span class="nf">binds</span><span class="o">(</span><span class="nc">Circle</span> <span class="n">c</span><span class="o">);</span>

<span class="nd">@Binds</span>
<span class="nd">@IntoMap</span>
<span class="nd">@StringKey</span><span class="o">(</span><span class="s">"square"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">Shape</span> <span class="nf">binds</span><span class="o">(</span><span class="nc">Square</span> <span class="n">c</span><span class="o">);</span>

<span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyComponent</span> <span class="o">{</span>
   
   <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Shape</span><span class="o">&gt;</span> <span class="nf">getShapesRegistry</span><span class="o">();</span>
<span class="o">}</span>


<span class="c1">// target class</span>

<span class="nc">MyComponent</span> <span class="n">myComponent</span><span class="o">;</span>

<span class="n">myComponent</span><span class="o">.</span><span class="na">getShapesRegistry</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"square"</span><span class="o">)</span> <span class="c1">// Square</span>
<span class="n">myComponent</span><span class="o">.</span><span class="na">getShapesRegistry</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="s">"circle"</span><span class="o">)</span>

</pre></table></code></div></div><p>The above code places both Square and Circle in the component’s map <code class="language-plaintext highlighter-rouge">Map&lt;String, Shape&gt;</code>. Target class shall request this map from component and access the instance using a key string.</p><hr /><h2 id="️--recap">🎞️ Recap</h2><p>Dagger section should give some idea of what happens with constructor injection &amp; multi-bindings. This will help us go through the hilt workflow quickly. Recalling few things from the previous article:</p><ul><li>Sample project <a href="https://github.com/mahendranv/hilt-espresso">github</a><li>Viewmodel-fragment dependency graph</ul><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/135462794-dfc37daa-96e7-49f3-bcda-35cc8f911e7d.png" alt="image" /></p><p>We’ll cover the workings of HiltViewModel and AndriodEntryPoint in the rest of the article.</p><hr /><h2 id="-hiltviewmodel--annotation">🪡 HiltViewModel — annotation</h2><p>When we mark a ViewModel as <code class="language-plaintext highlighter-rouge">HiltViewModel</code>, Hilt creates a module and dagger factory for it. This factory is something we’ve seen briefly in dagger section. Our viewmodel requests for a data-repository and respective provider is placed in the factory.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@HiltViewModel</span>
<span class="kd">class</span> <span class="nc">ProfileViewModel</span> <span class="nd">@Inject</span> <span class="k">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="kd">val</span> <span class="py">repo</span><span class="p">:</span> <span class="nc">DataRepository</span>
<span class="p">)</span> <span class="p">:</span> <span class="nc">ViewModel</span><span class="p">()</span>
</pre></table></code></div></div><p>generates</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">dagger.internal.Factory</span><span class="o">;</span>

<span class="nd">@DaggerGenerated</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ProfileViewModel_Factory</span> <span class="kd">implements</span> <span class="nc">Factory</span><span class="o">&lt;</span><span class="nc">ProfileViewModel</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Provider</span><span class="o">&lt;</span><span class="nc">DataRepository</span><span class="o">&gt;</span> <span class="n">repoProvider</span><span class="o">;</span>

  <span class="c1">//redacted</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">ProfileViewModel</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nf">newInstance</span><span class="o">(</span><span class="n">repoProvider</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ProfileViewModel</span> <span class="nf">newInstance</span><span class="o">(</span><span class="nc">DataRepository</span> <span class="n">repo</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">ProfileViewModel</span><span class="o">(</span><span class="n">repo</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><p>The factory resolves dependencies of the viewmodel. And it can create <code class="language-plaintext highlighter-rouge">ProfileViewModel</code> if someone requests it. The next step is to expose this factory to the outer layer. For this hilt generates a dagger module for each HiltViewModel. These modules will register themselves to Hilt’s ViewModelComponent. Here, ViewModelComponent keeps a multibinding map of <code class="language-plaintext highlighter-rouge">Map&lt;String, ViewModel&gt;</code>. And the key is the fully qualified class name.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ProfileViewModel_HiltModules</span> <span class="o">{</span>
  
  <span class="nd">@Module</span>
  <span class="nd">@InstallIn</span><span class="o">(</span><span class="nc">ViewModelComponent</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">BindsModule</span> <span class="o">{</span>
    
    <span class="nd">@Binds</span>
    <span class="nd">@IntoMap</span>
    <span class="nd">@StringKey</span><span class="o">(</span><span class="s">"com.ex2.hiltespresso.ui.profile.ProfileViewModel"</span><span class="o">)</span>
    <span class="nd">@HiltViewModelMap</span>
    <span class="kd">public</span> <span class="kd">abstract</span> <span class="nc">ViewModel</span> <span class="nf">binds</span><span class="o">(</span><span class="nc">ProfileViewModel</span> <span class="n">vm</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>

</pre></table></code></div></div><p>So, our viewmodel code is read as <strong>bind</strong> ProfileViewModel for ViewModel and register to the component’s map (<strong>IntoMap</strong>) against the <strong>StringKey</strong> which is <code class="language-plaintext highlighter-rouge">com.ex2.hiltespresso.ui.profile.ProfileViewModel</code>.</p><p>…</p><p>Till now, we covered the viewmodel instantiation and how ViewModelComponent keeps track of ViewModels. This is the producer side of the equation and the consumption is covered in the rest of the article.</p><hr /><h2 id="-androidentrypoint">🎯 AndroidEntryPoint</h2><blockquote><p><big><strong>Note</strong>: In this article run into Dagger Factory &amp; ViewModel Factory. So, to avoid ambiguity - lets call ViewModel Factory as VMFactory.</big></p></blockquote><p>In a traditional viewmodel usecase, fragment/activity (UI) takes responsibility to provide VMFactory if there is any dependency. <a href="https://dev.to/mahendranv/how-viewmodel-survives-configuration-change-67p#viewmodel-with-dependencies">This article</a> covers how VMFactory instantiates viewmodel with dependencies.</p><p><img data-proofer-ignore data-src="https://res.cloudinary.com/practicaldev/image/fetch/s--Vw5-IH9---/c_limit%2Cf_auto%2Cfl_progressive%2Cq_auto%2Cw_880/https://user-images.githubusercontent.com/6584143/135660480-6fa7298a-513b-4dac-80c5-1bc1e2d05461.png" alt="image" /></p><p>…</p><p>Hilt augments the existing viewmodel framework by generating VMFactory for us. For this, it uses marker annotations <code class="language-plaintext highlighter-rouge">AndroidEntryPoint</code> and <code class="language-plaintext highlighter-rouge">HiltViewModel</code>.</p><p>AndroidEntryPoint is a Hilt annotation to mark an Activity or Fragment as a receiver of the dependency. So, things discussed here with fragment will work for activity as well.</p><p>…</p><p>Our ProfileFragment is extended from Fragment right? Only it is not!! <code class="language-plaintext highlighter-rouge">hilt-android-gradle-plugin</code> gradle plugin will generate a proxy fragment and set it as base for ProfileFragment. Here, what we see vs the one that goes into the APK.</p><div class="language-kotlin highlighter-rouge"><div class="code-header"> <span text-data=" Kotlin "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nd">@AndroidEntryPoint</span>
<span class="kd">class</span> <span class="nc">ProfileFragment</span> <span class="p">:</span> <span class="nc">Fragment</span><span class="p">()</span>

<span class="n">vs</span>

<span class="kd">class</span> <span class="nc">ProfileFragment</span> <span class="p">:</span> <span class="nc">Hilt_ProfileFragment</span><span class="p">()</span>
</pre></table></code></div></div><p>…</p><p>Hilt uses the generated fragment to hook up its <code class="language-plaintext highlighter-rouge">HiltViewModelFactory</code>. This VMFactory has access to the viewmodel component and the rest of the dependency graph. Following block diagram shows the components and relations. Let’s go through each of them.</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/135807886-b7ae5e81-db4f-4995-92f8-d71e7dee4f1a.png" alt="image" /></p><h3 id="hilt_profilefragment--the-generated-fragment">Hilt_ProfileFragment — the generated fragment</h3><p>The generated fragment injects the dependencies through the member injector and overrides the default VMFactory with HiltViewModelFactory. ViewModelProvider will recognize the HiltViewModelFactory and use it to create ProfileViewModel. There are in-line comments in respective places for understanding the generated fragment.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Hilt_ProfileFragment</span> <span class="kd">extends</span> <span class="nc">Fragment</span> <span class="kd">implements</span> <span class="nc">GeneratedComponentManagerHolder</span> <span class="o">{</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAttach</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">inject</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onAttach</span><span class="o">(</span><span class="nc">Activity</span> <span class="n">activity</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// This will inject surface level dependencies (ex. sharedpreference </span>
    <span class="c1">// or analytics client needed for reporting click etc.) </span>
    <span class="c1">// used in view layer.</span>
    <span class="n">inject</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">inject</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">injected</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">injected</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
      <span class="o">((</span><span class="n">ProfileFragment_GeneratedInjector</span><span class="o">)</span> <span class="k">this</span><span class="o">.</span><span class="na">generatedComponent</span><span class="o">()).</span><span class="na">injectProfileFragment</span><span class="o">(</span><span class="nc">UnsafeCasts</span><span class="o">.&lt;</span><span class="nc">ProfileFragment</span><span class="o">&gt;</span><span class="n">unsafeCast</span><span class="o">(</span><span class="k">this</span><span class="o">));</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="c1">// This method will be invoked by ViewModelProvider in case there is </span>
  <span class="c1">// no explicit VMFactory is provided. Hilt uses this method to enroll its</span>
  <span class="c1">// HiltViewModelFactory with ViewModelProvider.</span>
  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="nc">ViewModelProvider</span><span class="o">.</span><span class="na">Factory</span> <span class="nf">getDefaultViewModelProviderFactory</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// DefaultViewModelFactories is a utility class that delegates calls to </span>
    <span class="c1">// hilt generated viewmodel registry which created in previous section</span>
    <span class="k">return</span> <span class="nc">DefaultViewModelFactories</span><span class="o">.</span><span class="na">getFragmentFactory</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="kd">super</span><span class="o">.</span><span class="na">getDefaultViewModelProviderFactory</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>

  <span class="c1">// File: DefaultViewModelFactories.java</span>

  <span class="cm">/**
   * Retrieves the default view model factory for the activity.
   * &lt;p&gt;Do not use except in Hilt generated code!
   */</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="nc">ViewModelProvider</span><span class="o">.</span><span class="na">Factory</span> <span class="nf">getFragmentFactory</span><span class="o">(</span>
      <span class="nc">Fragment</span> <span class="n">fragment</span><span class="o">,</span> <span class="nc">ViewModelProvider</span><span class="o">.</span><span class="na">Factory</span> <span class="n">delegateFactory</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">EntryPoints</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">fragment</span><span class="o">,</span> <span class="nc">FragmentEntryPoint</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
        <span class="o">.</span><span class="na">getHiltInternalFactoryFactory</span><span class="o">()</span>
        <span class="o">.</span><span class="na">fromFragment</span><span class="o">(</span><span class="n">fragment</span><span class="o">,</span> <span class="n">delegateFactory</span><span class="o">);</span>
  <span class="o">}</span>
</pre></table></code></div></div><h3 id="internalfactoryfactory">InternalFactoryFactory</h3><p><code class="language-plaintext highlighter-rouge">InternalFactoryFactory</code> can is responsible for forwarding the ViewModelComponent builder and list of known hilt viewmodel names to the HiltViewModelFactory. Here, the ViewmodelComponent is a dagger component defined by hilt. We have already provided it with dependencies for <code class="language-plaintext highlighter-rouge">ProfileViewModel</code>.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">InternalFactoryFactory</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Application</span> <span class="n">application</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">keySet</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ViewModelComponentBuilder</span> <span class="n">viewModelComponentBuilder</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nc">ViewModelProvider</span><span class="o">.</span><span class="na">Factory</span> <span class="nf">getHiltViewModelFactory</span><span class="o">(</span>
        <span class="nc">SavedStateRegistryOwner</span> <span class="n">owner</span><span class="o">,</span>
        <span class="nd">@Nullable</span> <span class="nc">Bundle</span> <span class="n">defaultArgs</span><span class="o">,</span>
        <span class="nd">@Nullable</span> <span class="nc">ViewModelProvider</span><span class="o">.</span><span class="na">Factory</span> <span class="n">extensionDelegate</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">ViewModelProvider</span><span class="o">.</span><span class="na">Factory</span> <span class="n">delegate</span> <span class="o">=</span> <span class="n">extensionDelegate</span> <span class="o">==</span> <span class="kc">null</span>
          <span class="o">?</span> <span class="k">new</span> <span class="nc">SavedStateViewModelFactory</span><span class="o">(</span><span class="n">application</span><span class="o">,</span> <span class="n">owner</span><span class="o">,</span> <span class="n">defaultArgs</span><span class="o">)</span>
          <span class="o">:</span> <span class="n">extensionDelegate</span><span class="o">;</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">HiltViewModelFactory</span><span class="o">(</span>
          <span class="n">owner</span><span class="o">,</span> <span class="n">defaultArgs</span><span class="o">,</span> <span class="n">keySet</span><span class="o">,</span> <span class="n">delegate</span><span class="o">,</span> <span class="n">viewModelComponentBuilder</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><hr /><h2 id="-final-piece---the-hiltviewmodelfactory">🧩 Final piece - The HiltViewModelFactory</h2><p><code class="language-plaintext highlighter-rouge">HiltViewModelFactory</code> is a subclass of ViewModelFactory. Responsibility of this class is to instantiate the given ViewModel. This block diagram explains the control flow</p><p><img data-proofer-ignore data-src="https://user-images.githubusercontent.com/6584143/135831324-dce01038-9e08-4c5d-9481-93a0fa628623.png" alt="image" /></p><ol><li>InternalFactoryFactory forwards the set of viewmodel names and a viewmodel component builder to HiltViewModelFactory through constructor. Now the <code class="language-plaintext highlighter-rouge">HiltViewModelFactory</code> has been created and await the consumer to call create.<li>Fragment/activity calls create to get instance of the viewmodel. Now, HiltViewModelFactory builds a viewmodel component from the existing builder and asks for a map of provider<ViewModel> instances.</ViewModel><li>From there, it picks the matching provider and uses it to instantiate the viewmodel.<li>Delivers it to the ViewModelProvider</ol><p>Code looks like this: HiltViewModelFactory holds a list of known hilt viewmodel names and hiltViewModelFactory and an optional delegateFactory. List of ViewModel names determine whether to use <code class="language-plaintext highlighter-rouge">delegateFactory</code> or <code class="language-plaintext highlighter-rouge">hiltViewModelFactory</code>.</p><div class="language-java highlighter-rouge"><div class="code-header"> <span text-data=" Java "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">HiltViewModelFactory</span> <span class="kd">implements</span> <span class="nc">ViewModelProvider</span><span class="o">.</span><span class="na">Factory</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Set</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">hiltViewModelKeys</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ViewModelProvider</span><span class="o">.</span><span class="na">Factory</span> <span class="n">delegateFactory</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="nc">AbstractSavedStateViewModelFactory</span> <span class="n">hiltViewModelFactory</span><span class="o">;</span>

  <span class="c1">// redacted</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="o">&lt;</span><span class="no">T</span> <span class="kd">extends</span> <span class="nc">ViewModel</span><span class="o">&gt;</span> <span class="no">T</span> <span class="nf">create</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Class</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">modelClass</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">hiltViewModelKeys</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">modelClass</span><span class="o">.</span><span class="na">getName</span><span class="o">()))</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">hiltViewModelFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">modelClass</span><span class="o">);</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">delegateFactory</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">modelClass</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><hr /><h2 id="-wrap-up">🍬 Wrap up</h2><ul><li>Hilt creates a Dagger Factory for the ViewModel. This contains the providers for the particular viewmodel’s dependencies and a key that uniquely identifies it (fully qualified name). This is a registry step that holds info on a ViewModel’s name and how to create it.<li>When a fragment is marked as AndroidEntryPoint, it will be set with a generated base class that takes care of injecting fields to the fragment.<li>However, ViewModel is a special case. So, hilt will try to provide a ViewModelFactory.<li>Above step is done with <code class="language-plaintext highlighter-rouge">InternalFactoryFactory</code>. It creates <code class="language-plaintext highlighter-rouge">HiltViewModelFactory</code> and passes on the component to it.<li>HiltViewModelFactory lookup in the registry (created in the first step) and instantiates the requested viewmodel.</ul><hr /><h2 id="-resources">📖 Resources</h2><ul><li><a href="https://github.com/mahendranv/hilt-espresso">Sample project source</a><li><a href="https://dagger.dev/dev-guide/multibindings.html">Dagger multi-binding</a><li><a href="https://dev.to/mahendranv/how-viewmodel-survives-configuration-change-67p">ViewModel instantiation</a></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>Android</a>, <a href='/categories/hilt/'>Hilt</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >android</a> <a href="/tags/hilt/" class="post-tag no-text-decoration" >hilt</a> <a href="/tags/dagger/" class="post-tag no-text-decoration" >dagger</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Smoke, mirrors & HiltViewModel - Mahendran&url=https://mahendranv.github.io/posts/hilt-codegen/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Smoke, mirrors & HiltViewModel - Mahendran&u=https://mahendranv.github.io/posts/hilt-codegen/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Smoke, mirrors & HiltViewModel - Mahendran&url=https://mahendranv.github.io/posts/hilt-codegen/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/hilt-instrument/">Android — Instrumentation test with hilt</a><li><a href="/posts/hilt-codegen/">Smoke, mirrors & HiltViewModel</a><li><a href="/posts/hilt-viewmodel/">Android — Basic Hilt setup with viewmodel + fragment</a><li><a href="/posts/viewmodel-store/">Android — ViewModel factory and instantiation</a><li><a href="/posts/compose-shapes-gists/">I created few shapes in Jetpack compose / Gist included</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/hilt-viewmodel/"><div class="card-body"> <span class="timeago small" >Sep 28, 2021<i class="unloaded">2021-09-28T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android — Basic Hilt setup with viewmodel + fragment</h3><div class="text-muted small"><p> Hilt is a modern android DI framework for dependency injection. It is merely a wrapper around Dagger2. Forget dagger-android, hilt brings a lot to our plate. This article covers steps to add hilt t...</p></div></div></a></div><div class="card"> <a href="/posts/hilt-instrument/"><div class="card-body"> <span class="timeago small" >Oct 20, 2021<i class="unloaded">2021-10-20T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Android — Instrumentation test with hilt</h3><div class="text-muted small"><p> Testing in Android has been a pain from the beginning and there is no standard architecture setup to execute the frictionless test. As you know there is no silver bullet for all the snags. This pie...</p></div></div></a></div><div class="card"> <a href="/posts/kotlin-safe-cast/"><div class="card-body"> <span class="timeago small" >Apr 14, 2021<i class="unloaded">2021-04-14T00:00:00+05:30</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Kotlin safe casting</h3><div class="text-muted small"><p> In multiple cases you might’ve came across the situation where you have to cast a global variable and check the instance beforehand. A most common case in Android environment is to check whether...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/viewmodel-store/" class="btn btn-outline-primary" prompt="Older"><p>Android — ViewModel factory and instantiation</p></a> <a href="/posts/hilt-instrument/" class="btn btn-outline-primary" prompt="Newer"><p>Android — Instrumentation test with hilt</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/mahevelai">Mahendran Vadivalagan</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">android</a> <a class="post-tag" href="/tags/kotlin/">kotlin</a> <a class="post-tag" href="/tags/graphql/">graphql</a> <a class="post-tag" href="/tags/springboot/">springboot</a> <a class="post-tag" href="/tags/compose/">compose</a> <a class="post-tag" href="/tags/coding/">coding</a> <a class="post-tag" href="/tags/hilt/">hilt</a> <a class="post-tag" href="/tags/dagger/">dagger</a> <a class="post-tag" href="/tags/dribbble/">dribbble</a> <a class="post-tag" href="/tags/tools/">tools</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://mahendranv.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
